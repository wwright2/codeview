<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>winsocket problem, 2 accept() for 1 clie - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/windows/">Windows Programming</a></li>
<li class="here">winsocket problem, 2 accept() for 1 clie</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico solved" title="solved">&nbsp;</div> winsocket problem, 2 accept() for 1 client?</h3><span id="CH_edttl"></span><span class="rootdatPost" title="181962,root,0,-1,4,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg892109"><span title="892109,131012,1023,136,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892109" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm85f6b40979" title="Wed, 30 Dec 2015 18:05:29 +0000"></span><script type="text/javascript">WhenId('CH_zTm85f6b40979');</script><noscript>Dec 30, 2015 at 6:05pm UTC</noscript></div>
<div class="dwho"><a href="/user/Gyiove/"><b>Gyiove</b> (136)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892109">
Hello everyone!<br>
<br>
Here's my socket class:<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>153<br>154<br>155<br>156<br>157<br>158<br>159<br>160<br>161<br>162<br>163<br>164<br>165<br>166<br>167<br>168<br>169<br>170<br>171<br>172<br>173<br>174<br>175<br>176<br>177<br>178<br>179<br>180<br>181<br>182<br>183<br>184<br>185<br>186<br>187<br>188<br>189<br>190<br>191<br>192<br>193<br></code></pre></td>
<td class="source"><pre><code><var>class</var> spSocket
{
<var>public</var>:
	SOCKET psocket;
	spchar *ip;
	spchar *port;
	spchar *error;

	spSocket()
	{
		port = 0;
		ip = <var>new</var> spchar(20);
		port = <var>new</var> spchar(20);
		error = <var>new</var> spchar(256);
		psocket = INVALID_SOCKET;
	}

	<var>unsigned</var> <var>int</var> invalid()
	{
		<var>return</var> INVALID_SOCKET;
	}

	<var>int</var> sendmessage(SOCKET sin, <var>void</var> *in, <var>int</var> size)
	{
		<var>int</var> r = send(sin, (<var>char</var> *)in, size, 0);
		<var>return</var> r;
	}

	<var>int</var> receivemessage(SOCKET sin, <var>void</var> *out, <var>int</var> size)
	{
		<var>int</var> r = recv(sin, (<var>char</var> *)out, size, 0);
		<var>return</var> r;
	}

	SOCKET WaitForClient()
	{
		<var>return</var> accept(psocket, NULL, NULL);
	}

	<var>void</var> CloseConnection()
	{
		<var>if</var> (psocket == INVALID_SOCKET) <var>return</var>;
		closesocket(psocket);
		psocket = INVALID_SOCKET;
	}

	<var>void</var> CloseConnection(SOCKET in)
	{
		<var>if</var> (in != INVALID_SOCKET) closesocket(in);
		<var>if</var> (psocket == INVALID_SOCKET) <var>return</var>;
		closesocket(psocket);
		psocket = INVALID_SOCKET;
	}

	<var>bool</var> CreateServer(spchar IP, spchar PORT)
	{
		*ip = IP;
		*port = PORT;
		WSADATA wsaData;
		psocket = INVALID_SOCKET;

		<var>struct</var> addrinfo *result = NULL;
		<var>struct</var> addrinfo hints;

		<var>int</var> iResult = WSAStartup(MAKEWORD(2, 2), &amp;wsaData);
		<var>if</var> (iResult != 0) {
			error-&gt;format(<kbd>"WSAStartup failed with error: %d\n"</kbd>, iResult);
			<var>return</var> <var>false</var>;
		}

		ZeroMemory(&amp;hints, <var>sizeof</var>(hints));
		hints.ai_family = AF_INET;
		hints.ai_socktype = SOCK_STREAM;
		hints.ai_protocol = IPPROTO_TCP;
		hints.ai_flags = AI_PASSIVE;

		<var>if</var> (ip-&gt;size) iResult = getaddrinfo(ip-&gt;getchar(), port-&gt;getchar(), &amp;hints, &amp;result);
		<var>else</var> iResult = getaddrinfo(NULL, port-&gt;getchar(), &amp;hints, &amp;result);

		<var>if</var> (iResult != 0) {
			error-&gt;format(<kbd>"getaddrinfo failed with error: %d\n"</kbd>, iResult);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		psocket = socket(result-&gt;ai_family, result-&gt;ai_socktype, result-&gt;ai_protocol);

		<var>if</var> (psocket == INVALID_SOCKET) {
			error-&gt;format(<kbd>"socket failed with error: %ld\n"</kbd>, WSAGetLastError());
			freeaddrinfo(result);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		<var>if</var> (iResult == SOCKET_ERROR) {
			error-&gt;format(<kbd>"ioctlsocket failed with error: %d\n"</kbd>, WSAGetLastError());
			closesocket(psocket);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		iResult = bind(psocket, result-&gt;ai_addr, (<var>int</var>)result-&gt;ai_addrlen);
		<var>if</var> (iResult == SOCKET_ERROR) {
			error-&gt;format(<kbd>"bind failed with error: %d\n"</kbd>, WSAGetLastError());
			freeaddrinfo(result);
			closesocket(psocket);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		freeaddrinfo(result);
		iResult = listen(psocket, SOMAXCONN);

		<var>if</var> (iResult == SOCKET_ERROR) {
			error-&gt;format(<kbd>"listen failed with error: %d\n"</kbd>, WSAGetLastError());
			closesocket(psocket);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}
		<var>return</var> <var>true</var>;
	}

	<var>bool</var> Connect(spchar IP, spchar PORT)
	{
		*ip = IP;
		*port = PORT;
		WSADATA wsaData;
		<var>struct</var> addrinfo *result = NULL, *ptr = NULL, hints;
		<var>int</var> iResult = WSAStartup(MAKEWORD(2, 2), &amp;wsaData);

		<var>if</var> (iResult != 0) {
			error-&gt;format(<kbd>"WSAStartup failed with error: %d\n"</kbd>, iResult);
			<var>return</var> <var>false</var>;
		}

		ZeroMemory(&amp;hints, <var>sizeof</var>(hints));
		hints.ai_family = AF_UNSPEC;
		hints.ai_socktype = SOCK_STREAM;
		hints.ai_protocol = IPPROTO_TCP;
		iResult = getaddrinfo(ip-&gt;getchar(), port-&gt;getchar(), &amp;hints, &amp;result);

		<var>if</var> (iResult != 0)
		{
			error-&gt;format(<kbd>"getaddrinfo failed with error: %d\n"</kbd>, iResult);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		<var>for</var> (ptr = result; ptr != NULL; ptr = ptr-&gt;ai_next) 
		{
			psocket = socket(ptr-&gt;ai_family, ptr-&gt;ai_socktype, ptr-&gt;ai_protocol);

			<var>if</var> (psocket == INVALID_SOCKET) {
				error-&gt;format(<kbd>"socket failed with error: %ld\n"</kbd>, WSAGetLastError());
				WSACleanup();
				<var>return</var> <var>false</var>;
			}

			iResult = connect(psocket, ptr-&gt;ai_addr, (<var>int</var>)ptr-&gt;ai_addrlen);

			<var>if</var> (iResult == SOCKET_ERROR)
			{
				closesocket(psocket);
				psocket = INVALID_SOCKET;
				error-&gt;format(<kbd>"The server is down... did not connect"</kbd>);
			}
		}

		freeaddrinfo(result);

		<var>if</var> (psocket == INVALID_SOCKET)
		{
			error-&gt;format(<kbd>"Unable to connect to server!\n"</kbd>);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}

		<var>if</var> (iResult == SOCKET_ERROR)
		{
			error-&gt;format(<kbd>"ioctlsocket failed with error: %d\n"</kbd>, WSAGetLastError());
			closesocket(psocket);
			WSACleanup();
			<var>return</var> <var>false</var>;
		}
		<var>return</var> <var>true</var>;
	}

	~spSocket()
	{


	}
};</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
This is how i'm using it:<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br></code></pre></td>
<td class="source"><pre><code><var>int</var> _tmain(<var>int</var> argc, _TCHAR* argv[])
{
	<cite>/*cout &lt;&lt; "1- create server" &lt;&lt; endl;
	cout &lt;&lt; "2- create client" &lt;&lt; endl;*/</cite>

	cout &lt;&lt; <kbd>"3- create simple server"</kbd> &lt;&lt; endl;
	cout &lt;&lt; <kbd>"4- create simple client"</kbd> &lt;&lt; endl;
	cout &lt;&lt; endl &lt;&lt; endl;
	<var>int</var> o = 1;
	running = 0;
	cin &gt;&gt; o;

	<var>if</var> (o == 3)
	{
		<var>char</var> buffer[128];
		spSocket a;
		a.CreateServer(<kbd>""</kbd>, <kbd>"27000"</kbd>);
		SOCKET t = a.WaitForClient();
		<cite>/*
		This last WaitForClient should block my program and wait for another connection
		but it doesn't do that.
		The last one returns valid client SOCKET but the first one is unknown for me.
		*/</cite>
		t = a.WaitForClient(); 

		a.receivemessage(t, buffer, 128);
		cout &lt;&lt; <kbd>"got message:"</kbd> &lt;&lt; buffer &lt;&lt; endl;

		cin &gt;&gt; buffer;
		cout &lt;&lt; <kbd>"sending:"</kbd> &lt;&lt; buffer &lt;&lt; endl;
		a.sendmessage(t, buffer, 128);
		system(<kbd>"pause"</kbd>);
		<var>return</var> 0;
	}

	<var>if</var> (o == 4)
	{
		<var>char</var> buffer[128];
		spSocket a;
		a.Connect(<kbd>""</kbd>, <kbd>"27000"</kbd>);
		cin &gt;&gt; buffer;
		cout &lt;&lt; <kbd>"sending:"</kbd> &lt;&lt; buffer &lt;&lt; endl;
		a.sendmessage(a.psocket, buffer, 128);

		a.receivemessage(a.psocket, buffer, 128);
		cout &lt;&lt; <kbd>"got message:"</kbd> &lt;&lt; buffer &lt;&lt; endl;
		system(<kbd>"pause"</kbd>);
		<var>return</var> 0;
	}
	system(<kbd>"pause"</kbd>);
	<var>return</var> 0;
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Thanks!
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmcd9f53daaf" title="Thu, 31 Dec 2015 11:21:44 +0000"></span><script type="text/javascript">WhenId('CH_zTmcd9f53daaf');</script><noscript>Dec 31, 2015 at 11:21am UTC</noscript></span>
<span class="dbtn" id="CH_btn892109"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892223"><span title="892223,131012,1023,136,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892223" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm94e77c083c" title="Thu, 31 Dec 2015 16:32:59 +0000"></span><script type="text/javascript">WhenId('CH_zTm94e77c083c');</script><noscript>Dec 31, 2015 at 4:32pm UTC</noscript></div>
<div class="dwho"><a href="/user/Gyiove/"><b>Gyiove</b> (136)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892223">
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br></code></pre></td>
<td class="source"><pre><code>		<cite>/* i
		nside:
		bool Connect(spchar IP, spchar PORT) 
		*/</cite>

		<var>for</var> (ptr = result; ptr != NULL; ptr = ptr-&gt;ai_next) 
		{
			psocket = socket(ptr-&gt;ai_family, ptr-&gt;ai_socktype, ptr-&gt;ai_protocol);

			<var>if</var> (psocket == INVALID_SOCKET) {
				error-&gt;format(<kbd>"socket failed with error: %ld\n"</kbd>, WSAGetLastError());
				WSACleanup();
				<var>return</var> <var>false</var>;
			}

			iResult = connect(psocket, ptr-&gt;ai_addr, (<var>int</var>)ptr-&gt;ai_addrlen);

			<var>if</var> (iResult == SOCKET_ERROR)
			{
				closesocket(psocket);
				psocket = INVALID_SOCKET;
				error-&gt;format(<kbd>"The server is down... did not connect"</kbd>);
				<var>continue</var>;
			}
			<var>break</var> <cite>// &lt;-- forgot to break.</cite>
		}</code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm6d25f9f854" title="Thu, 31 Dec 2015 17:10:51 +0000"></span><script type="text/javascript">WhenId('CH_zTm6d25f9f854');</script><noscript>Dec 31, 2015 at 5:10pm UTC</noscript></span>
<span class="dbtn" id="CH_btn892223"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892228"><span title="892228,79528,1023,99,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892228" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTme13d50907c" title="Thu, 31 Dec 2015 16:54:47 +0000"></span><script type="text/javascript">WhenId('CH_zTme13d50907c');</script><noscript>Dec 31, 2015 at 4:54pm UTC</noscript></div>
<div class="dwho"><a href="/user/AcarX/"><b>AcarX</b> (99)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892228">
Shouldn't you also add <span class="auto"><code class="source"><var>continue</var>;</code></span> after <span class="auto"><code class="source">error-&gt;format(<kbd>"The server is down... did not connect"</kbd>);</code></span> ?
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmeed38ae9c7" title="Fri, 01 Jan 2016 11:08:55 +0000"></span><script type="text/javascript">WhenId('CH_zTmeed38ae9c7');</script><noscript>Jan 1, 2016 at 11:08am UTC</noscript></span>
<span class="dbtn" id="CH_btn892228"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892230"><span title="892230,131012,1023,136,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892230" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTma6c0a6e4e9" title="Thu, 31 Dec 2015 17:10:19 +0000"></span><script type="text/javascript">WhenId('CH_zTma6c0a6e4e9');</script><noscript>Dec 31, 2015 at 5:10pm UTC</noscript></div>
<div class="dwho"><a href="/user/Gyiove/"><b>Gyiove</b> (136)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892230">
oh yeah thanks.<br>
I already did it actually in my code back in project yet i forgot to bring that update here.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn892230"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Topic archived. No new replies allowed.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(181962,1,131012,1,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li class="selected"><a href="/forum/windows/"><b>Windows Programming</b></a></li><li><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Fwindows%2F181962%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>