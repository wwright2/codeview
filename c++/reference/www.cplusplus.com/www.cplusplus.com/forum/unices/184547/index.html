<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>tcp/ip wrapping - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/unices/">UNIX/Linux Programming</a></li>
<li class="here">tcp/ip wrapping</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico question" title="question">&nbsp;</div> tcp/ip wrapping</h3><span id="CH_edttl"></span><span class="rootdatPost" title="184547,root,0,-1,6,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg902096"><span title="902096,212074,1023,6,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902096" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmabe570dc32" title="Sun, 14 Feb 2016 07:27:57 +0000"></span><script type="text/javascript">WhenId('CH_zTmabe570dc32');</script><noscript>Feb 14, 2016 at 7:27am UTC</noscript></div>
<div class="dwho"><a href="/user/zezeon/"><b>zezeon</b> (6)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902096">
I want to wrap tcp/ip with C++, but, It does not work.<br>
Though I could establish connection but, I could not send or receive messages. <br>
Can anyone help me?<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br></code></pre></td>
<td class="source"><pre><code><cite>//tcpip.h class definition</cite>
<dfn>#include &lt;string&gt;</dfn>
<dfn>#include &lt;arpa/inet.h&gt;</dfn>

<var>class</var> Tcpip 
{
<var>public</var>:
	Tcpip(<var>int</var> port);
	<var>virtual</var> ~Tcpip();
	<var>void</var> send(std::string s);
	std::string recv();

<var>protected</var>:
	<var>int</var> server_fd, client_fd;
	<var>struct</var> sockaddr_in server_addr, client_addr;

<var>private</var>:
	<var>char</var> buffer[1024];
};

<var>class</var> Client : <var>public</var> Tcpip
{
<var>public</var>:
	Client(std::string ip = <kbd>"127.0.0.1"</kbd>, <var>int</var> port = 2001); 
};

<var>class</var> Server : <var>public</var> Tcpip
{
<var>public</var>:
	Server(<var>int</var> port = 2001, <var>int</var> queue = 10);
};


<cite>//tcpip.cc class realization</cite>
<dfn>#include &lt;sys/socket.h&gt;</dfn>
<dfn>#include &lt;sys/types.h&gt;</dfn>
<dfn>#include &lt;cstdlib&gt;</dfn>
<dfn>#include &lt;cstdio&gt;</dfn>
<dfn>#include &lt;unistd.h&gt;</dfn>
<dfn>#include &lt;cstring&gt;</dfn>
<dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include "tcpip.h"</dfn>
<var>using</var> <var>namespace</var> std;

Tcpip::Tcpip(<var>int</var> port) 
{
	memset(&amp;server_addr, 0, <var>sizeof</var>(server_addr));
	memset(&amp;client_addr, 0, <var>sizeof</var>(client_addr));
	server_addr.sin_family = AF_INET;
	server_addr.sin_port = htons(port);
	server_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	client_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
}

Tcpip::~Tcpip()
{
	close(client_fd);
}

<var>void</var> Tcpip::send(string s) 
{
	write(client_fd, s.c_str(), s.size()+1);
}

string Tcpip::recv()
{
	<var>int</var> i = read(client_fd, buffer, 1024);
	buffer[i] = 0;
	<var>return</var> string(buffer);
}

Client::Client(string ip, <var>int</var> port) : Tcpip(port) 
{
	server_addr.sin_addr.s_addr = inet_addr(ip.c_str());
	<var>if</var>(-1 == connect(client_fd, (sockaddr*)&amp;server_addr, <var>sizeof</var>(server_addr)))
		cout &lt;&lt; <kbd>"connect() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>" connecting"</kbd>  &lt;&lt;endl;
}

Server::Server(<var>int</var> port, <var>int</var> queue) : Tcpip(port) 
{
	server_addr.sin_addr.s_addr = htonl(INADDR_ANY);
	<var>if</var>(bind(server_fd, (sockaddr*)&amp;server_addr, <var>sizeof</var>(server_addr)) == -1)
		cout &lt;&lt; <kbd>"bind() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>"binding"</kbd> &lt;&lt; endl;
	<var>if</var>(listen(server_fd, queue) == -1) cout &lt;&lt; <kbd>"listen() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>"listening"</kbd> &lt;&lt; endl;
	<var>int</var> cl_size = <var>sizeof</var>(client_addr);
	<var>if</var>(client_fd = accept(server_fd, (sockaddr*)&amp;client_addr, (socklen_t*)&amp;cl_size) == -1)
		cout &lt;&lt; <kbd>"accept() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>"accepting"</kbd> &lt;&lt; endl;
}


<cite>//server exe</cite>
<dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include &lt;string&gt;</dfn>
<dfn>#include "tcpip.h"</dfn>
<var>using</var> <var>namespace</var> std;

<var>int</var> main()
{
	string s;
	Server sv;
<var>while</var>(s != <kbd>"end"</kbd>) {
	s = sv.recv();
	cout &lt;&lt; s;
	sv.send(s);
}
}

<cite>//client exe</cite>
<dfn>#include "tcpip.h"</dfn>
<dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include &lt;string&gt;</dfn>
<var>using</var> <var>namespace</var> std;

<var>int</var> main()
{
	string s;
	Client cl;
	<var>while</var>(1) {
		cin &gt;&gt; s;
		cl.send(s);
		cout &lt;&lt; cl.recv();
		<var>if</var>(s == <kbd>"end"</kbd>) <var>break</var>;
	}
}

<dfn>#Makefile</dfn>
CFLAG = -g -std=c++11 
CC = g++
SRC = $(wildcard *.cc)
OBJ = $(patsubst %.cc, %.o, $(SRC))

all : $(OBJ)
	g++ -o cl cl.o tcpip.o
	g++ -o sv sv.o tcpip.o
	
%.o : %.cc
	$(CC) -c $&lt; $(CFLAG)


clean : 
	rm *.o sv cl
<dfn>#	./$@ </dfn></code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmb1f0fe7707" title="Sun, 14 Feb 2016 07:32:36 +0000"></span><script type="text/javascript">WhenId('CH_zTmb1f0fe7707');</script><noscript>Feb 14, 2016 at 7:32am UTC</noscript></span>
<span class="dbtn" id="CH_btn902096"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902187"><span title="902187,212074,1023,6,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902187" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm0ecde66656" title="Sun, 14 Feb 2016 13:53:23 +0000"></span><script type="text/javascript">WhenId('CH_zTm0ecde66656');</script><noscript>Feb 14, 2016 at 1:53pm UTC</noscript></div>
<div class="dwho"><a href="/user/zezeon/"><b>zezeon</b> (6)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902187">
I have found that Tcpip::recv() function has a problem.<br>
The read(client_fd, ....) function at the line 67 is hanging.<br>
In GDB, It says ../sysdeps/unix/syscall-template.S: No such file or directory..<br>
<br>
What's wrong ?
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm65a9cab32c" title="Sun, 14 Feb 2016 13:53:53 +0000"></span><script type="text/javascript">WhenId('CH_zTm65a9cab32c');</script><noscript>Feb 14, 2016 at 1:53pm UTC</noscript></span>
<span class="dbtn" id="CH_btn902187"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902447"><span title="902447,17129,1023,7936,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902447" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm40c4b8bb28" title="Mon, 15 Feb 2016 11:50:30 +0000"></span><script type="text/javascript">WhenId('CH_zTm40c4b8bb28');</script><noscript>Feb 15, 2016 at 11:50am UTC</noscript></div>
<div class="dwho"><a href="/user/kbw/"><b>kbw</b> (7936)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902447">
Your design is wrong.  The base class has everything, and thus has to duplicate the content of the derived classes.  It doesn't manage the resources properly, and that's the whole point of encapsulation.<br>
<br>
For example, if Tcpip has a server_fd and client_fd, why doesn't the destructor release both?<br>
<br>
I's probably not worth looking any further ... but I have.<br>
<br>
The server code is nonsense.  Think about what accept() does.  What happens when a client connects two or three times serially.<br>
<br>
You probably don't need a makefile.  You can build it with this (after you've deleted the makefile):<br>
<div class="auto"><table class="snippet"><tr><td class="output"><pre><samp>CXXFLAGS="-g -std=c++11" make cl
CXXFLAGS="-g -std=c++11" make sv</samp></pre></td></tr></table></div><br>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm9660be55bd" title="Mon, 15 Feb 2016 12:18:10 +0000"></span><script type="text/javascript">WhenId('CH_zTm9660be55bd');</script><noscript>Feb 15, 2016 at 12:18pm UTC</noscript></span>
<span class="dbtn" id="CH_btn902447"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902654"><span title="902654,212074,1023,6,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902654" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm1d7d5fe5fa" title="Tue, 16 Feb 2016 08:13:44 +0000"></span><script type="text/javascript">WhenId('CH_zTm1d7d5fe5fa');</script><noscript>Feb 16, 2016 at 8:13am UTC</noscript></div>
<div class="dwho"><a href="/user/zezeon/"><b>zezeon</b> (6)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902654">
This is not a final code. Just a transitional code..<br>
So not working properly on multiple connections. I just need to add some fork() after debugging this.<br>
What I want to know is why it hangs at read function.<br>
Do you have any idea?<br>
And accept() works well in 1 connection after another situation.<br>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm5d81d671b8" title="Tue, 16 Feb 2016 08:16:54 +0000"></span><script type="text/javascript">WhenId('CH_zTm5d81d671b8');</script><noscript>Feb 16, 2016 at 8:16am UTC</noscript></span>
<span class="dbtn" id="CH_btn902654"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902664"><span title="902664,17129,1023,7936,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902664" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm0d1a0e90ea" title="Tue, 16 Feb 2016 09:46:20 +0000"></span><script type="text/javascript">WhenId('CH_zTm0d1a0e90ea');</script><noscript>Feb 16, 2016 at 9:46am UTC</noscript></div>
<div class="dwho"><a href="/user/kbw/"><b>kbw</b> (7936)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902664">
<table class="quote"><tr><td class="qd">And accept() works well in 1 connection after another situation.</td></tr></table><br>
I know, that's why I posted:<table class="quote"><tr><td class="qd">Think about what accept() does. What happens when a client connects two or three times serially.</td></tr></table><br>
<br>
I suggest you forget wrapping TCP in classes for now.  It's a very difficult problem, must harder than it first seems.<br>
<br>
I get it, TCP is such a pain to deal with, wouldn't it be nice if the complexity and details were wrapped up in something easy to use?  The answer is, it already is.<br>
<br>
Think of sockets as making networking as easy to use as files.  So you set them up, then just read/write them in the same way you'd do with file streams.  The logic goes like this.<br>
<br>
Client Side:<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br></code></pre></td>
<td class="source"><pre><code><var>int</var> fd = EstablishConnection(ip_address);
write/read on fd
close(fd)</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Server Side:<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br></code></pre></td>
<td class="source"><pre><code><var>int</var> fd = EstablistListenningConnection(ip_addresses)
<var>while</var> (listening)
    parallel
        <var>int</var> client_fd = accept(fd)
        read/write on client_fd
        close(client_fd)
    endparallel
endwhile
close(fd)</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
The thing to note is that each time a client connects, the server sees accecpt() return a new fd to communicate with that client on.  As the server should serve more than one client at a time, you need a way to manage each connection distinctly and concurrently.
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm9f78e29dc9" title="Tue, 16 Feb 2016 18:39:44 +0000"></span><script type="text/javascript">WhenId('CH_zTm9f78e29dc9');</script><noscript>Feb 16, 2016 at 6:39pm UTC</noscript></span>
<span class="dbtn" id="CH_btn902664"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg903239"><span title="903239,212074,1023,6,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903239" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm0a4cea1320" title="Thu, 18 Feb 2016 08:57:09 +0000"></span><script type="text/javascript">WhenId('CH_zTm0a4cea1320');</script><noscript>Feb 18, 2016 at 8:57am UTC</noscript></div>
<div class="dwho"><a href="/user/zezeon/"><b>zezeon</b> (6)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903239">
Thanks. There was no problem with the code. It hanged due to some other system side problem. <br>
I don't know what it is. Do you know some way to disrupt execution by mangling the library or some other thing? If this kind of things happen again where should I see first. Because these situations happen so much to me. <br>
<br>
I changed the code like this. Now it works very well. Even with multiple connections.<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>153<br>154<br>155<br>156<br>157<br>158<br>159<br>160<br>161<br>162<br>163<br>164<br></code></pre></td>
<td class="source"><pre><code><cite>//tcpip.h class definition</cite>
<dfn>#include &lt;string&gt;</dfn>
<dfn>#include &lt;thread&gt;</dfn>
<dfn>#include &lt;arpa/inet.h&gt;</dfn>

<var>class</var> Tcpip 
{
<var>public</var>:
	Tcpip(<var>int</var> port);
	<var>virtual</var> ~Tcpip();
	<var>void</var> send(std::string s);
	std::string recv();

<var>protected</var>:
	<var>int</var> server_fd, client_fd;
	<var>struct</var> sockaddr_in server_addr, client_addr;

<var>private</var>:
	<var>char</var> buffer[1024];
};

<var>class</var> Client : <var>public</var> Tcpip
{
<var>public</var>:
	Client(std::string ip = <kbd>"127.0.0.1"</kbd>, <var>int</var> port = 2001); 
};

<var>class</var> Server : <var>public</var> Tcpip
{
<var>public</var>:
	Server(<var>int</var> port = 2001, <var>int</var> queue = 10, std::string e = <kbd>"end"</kbd>);
	<var>void</var> start(std::string (*pf)(std::string s));

<var>protected</var>:
	std::string (*process_string)(std::string);
	<var>void</var> handle_connection();
	std::string end_string;
};



<cite>//tcpip.cc class realization</cite>
<dfn>#include &lt;sys/socket.h&gt;</dfn>
<dfn>#include &lt;sys/types.h&gt;</dfn>
<dfn>#include &lt;cstdlib&gt;</dfn>
<dfn>#include &lt;cstdio&gt;</dfn>
<dfn>#include &lt;unistd.h&gt;</dfn>
<dfn>#include &lt;cstring&gt;</dfn>
<dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include "tcpip.h"</dfn>
<var>using</var> <var>namespace</var> std;

Tcpip::Tcpip(<var>int</var> port) 
{
	memset(&amp;server_addr, 0, <var>sizeof</var>(server_addr));
	memset(&amp;client_addr, 0, <var>sizeof</var>(client_addr));
	server_addr.sin_family = AF_INET;
	server_addr.sin_port = htons(port);
	server_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	client_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
}

Tcpip::~Tcpip()
{
	close(client_fd);
	close(server_fd);
}

<var>void</var> Tcpip::send(string s) 
{
	write(client_fd, s.c_str(), s.size()+1);
}

string Tcpip::recv()
{
	<var>int</var> i = read(client_fd, buffer, 1023);<cite>//error</cite>
	buffer[i] = <kbd>'\0'</kbd>;
	<var>return</var> string(buffer);
}

Client::Client(string ip, <var>int</var> port) : Tcpip(port) 
{
	server_addr.sin_addr.s_addr = inet_addr(ip.c_str());
	<var>if</var>(-1 == connect(client_fd, (sockaddr*)&amp;server_addr, <var>sizeof</var>(server_addr)))
		cout &lt;&lt; <kbd>"connect() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>" connecting"</kbd>  &lt;&lt;endl;
}

Server::Server(<var>int</var> port, <var>int</var> queue, string e) : Tcpip(port) 
{
	end_string = e;
	server_addr.sin_addr.s_addr = htonl(INADDR_ANY);
	<var>if</var>(bind(server_fd, (sockaddr*)&amp;server_addr, <var>sizeof</var>(server_addr)) == -1)
		cout &lt;&lt; <kbd>"bind() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>"binding"</kbd> &lt;&lt; endl;
	<var>if</var>(listen(server_fd, queue) == -1) cout &lt;&lt; <kbd>"listen() error"</kbd> &lt;&lt; endl;
	<var>else</var> cout &lt;&lt; <kbd>"listening"</kbd> &lt;&lt; endl;
}

<var>void</var> Server::start(string (*pf)(string s))
{
	process_string = pf;
	<var>int</var> cl_size = <var>sizeof</var>(client_addr);
	<var>while</var>(1) {
		client_fd = accept(server_fd, (sockaddr*)&amp;client_addr, (socklen_t*)&amp;cl_size);
		<var>if</var>(client_fd == -1)	cout &lt;&lt; <kbd>"accept() error"</kbd> &lt;&lt; endl;
		<var>else</var> {
			cout &lt;&lt; <kbd>"accepting"</kbd> &lt;&lt; endl;
			<var>if</var>(fork() == 0) handle_connection();
		<cite>//	thread t(&amp;Server::handle_connection, this);</cite>
		<cite>//	t.detach();</cite>
		}
	}
}

<var>void</var> Server::handle_connection()
{
	string s;
	<var>while</var>(s != end_string) {
		s = recv();
		send(process_string(s));
	}
	cout &lt;&lt; <kbd>"ending child"</kbd> &lt;&lt; endl;
}



<cite>//server exe</cite>
<dfn>#include &lt;string&gt;</dfn>
<dfn>#include "tcpip.h"</dfn>
<var>using</var> <var>namespace</var> std;

string procedure(string s)
{
	string str = <kbd>"[from server] "</kbd>;
	str += s + <kbd>" : "</kbd> + to_string(s.size());
	<var>return</var> str;
}

<var>int</var> main()
{
	Server sv;
	sv.start(procedure);
}


<cite>//client exe</cite>
<dfn>#include "tcpip.h"</dfn>
<dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include &lt;string&gt;</dfn>
<var>using</var> <var>namespace</var> std;

<var>int</var> main(<var>int</var> argc, <var>char</var>** argv)
{
	string s = <kbd>"127.0.0.1"</kbd>;
	<var>if</var>(argc &gt; 1) s = argv[1];
	Client cl(s);
	s == <kbd>""</kbd>;
	<var>while</var>(s != <kbd>"end"</kbd>) {
		cin &gt;&gt; s;
		cl.send(s);
		cout &lt;&lt; cl.recv() &lt;&lt; endl;
	}
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmdfc7e07a9a" title="Thu, 18 Feb 2016 08:57:37 +0000"></span><script type="text/javascript">WhenId('CH_zTmdfc7e07a9a');</script><noscript>Feb 18, 2016 at 8:57am UTC</noscript></span>
<span class="dbtn" id="CH_btn903239"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Registered users can post here. <a href="/user/">Sign in or register</a> to post.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(184547,0,212074,0,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li><a href="/forum/windows/"><b>Windows Programming</b></a></li><li class="selected"><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Funices%2F184547%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>