<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>dlsym C++ problem. How to dynamically lo - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/unices/">UNIX/Linux Programming</a></li>
<li class="here">dlsym C++ problem. How to dynamically lo</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico question" title="question">&nbsp;</div> dlsym C++ problem. How to dynamically load C++ classes?</h3><span id="CH_edttl"></span><span class="rootdatPost" title="184342,root,0,-1,6,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg901334"><span title="901334,48752,1023,15,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg901334" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmd4ada51841" title="Thu, 11 Feb 2016 08:01:24 +0000"></span><script type="text/javascript">WhenId('CH_zTmd4ada51841');</script><noscript>Feb 11, 2016 at 8:01am UTC</noscript></div>
<div class="dwho"><a href="/user/phoenix911/"><b>phoenix911</b> (15)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i901334">
Hi, everyone!<br>
I need help very much with C++ on linux. Problem is, that I can dlsym "C" functions, even classes, but I cann't access class methods at all. Either it fails to compile, or I get segmentation fault.<br>
<br>
So currently it is like this:<br>
<br>
File testVir.h<br>
<br>
#ifndef TESTVIR_H<br>
#define TESTVIR_H<br>
 <br>
class TestVir<br>
{<br>
public:<br>
  virtual void init()=0;<br>
};<br>
 <br>
#endif<br>
<br>
File testLib.h<br>
<br>
#ifndef TESTLIB_H<br>
#define TESTLIB_H<br>
 <br>
class TestLib<br>
{<br>
 public:<br>
     void init();<br>
};<br>
 <br>
#endif<br>
<br>
File testLib.cpp<br>
<br>
#include &lt;iostream&gt;<br>
#include "testVir.h"<br>
#include "testLib.h"<br>
 <br>
using namespace std;<br>
void TestLib::init()<br>
{<br>
   cout&lt;&lt;"TestLib::init: Hello World!! "&lt;&lt;endl ;<br>
}<br>
 <br>
static TestLib *cr();<br>
//Define functions with C symbols (create/destroy TestLib instance).<br>
extern "C" TestLib* create()<br>
{<br>
    return cr();<br>
}<br>
<br>
static TestLib *cr()<br>
{<br>
    TestLib *test;<br>
    test = new TestLib;<br>
    return test;<br>
}<br>
<br>
extern "C" void destroy(TestLib* Tl)<br>
{<br>
   delete Tl ;<br>
}<br>
<br>
That named files above should be compiled as shared(.so) lib.<br>
<br>
Now comes main program, that tries to dlsym that and use it:<br>
<br>
#include&lt;iostream&gt;<br>
#include&lt;dlfcn.h&gt;<br>
#include "testVir.h"<br>
<br>
using namespace std;<br>
 <br>
int main()<br>
{<br>
    void *handle;<br>
    handle = dlopen("./testLib.so", RTLD_NOW);<br>
    if (!handle)<br>
    {<br>
           cout&lt;&lt; dlerror();<br>
    }<br>
 <br>
    typedef TestVir* create_t();<br>
    typedef void destroy_t(TestVir*);<br>
 <br>
    create_t* creat=(create_t*)dlsym(handle,"create");<br>
    destroy_t* destroy=(destroy_t*)dlsym(handle,"destroy");<br>
    if (!creat)<br>
    {<br>
           cout&lt;&lt;"The error is %s"&lt;&lt;dlerror();<br>
    }<br>
    if (!destroy)<br>
    {<br>
           cout&lt;&lt;"The error is %s"&lt;&lt;dlerror();<br>
    }<br>
    TestVir* tst = creat();<br>
    tst-&gt;init();<br>
    destroy(tst);<br>
    return 0 ;<br>
}<br>
<br>
Trying to use class's init() function leads to segmentation fault. Any ideas how to make it work? Thanks a lot!
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmaab3a9f3f7" title="Thu, 11 Feb 2016 08:02:22 +0000"></span><script type="text/javascript">WhenId('CH_zTmaab3a9f3f7');</script><noscript>Feb 11, 2016 at 8:02am UTC</noscript></span>
<span class="dbtn" id="CH_btn901334"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg901369"><span title="901369,17129,1023,7936,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg901369" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTme2d41e671f" title="Thu, 11 Feb 2016 10:15:23 +0000"></span><script type="text/javascript">WhenId('CH_zTme2d41e671f');</script><noscript>Feb 11, 2016 at 10:15am UTC</noscript></div>
<div class="dwho"><a href="/user/kbw/"><b>kbw</b> (7936)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i901369">
Please use code tags for your code.  The tags are in the palette to the right.<br>
<br>
You're kind of doing it wrong.  And it isn't a "Linux" thing either, you'll get exactly the same problem in Windows with any C++ environment.<br>
<br>
The problem you mean is you can get the function name with dlsym().  But you ought to know that where the symbolic name of C functions are known, the mangling scheme for C++ member functions isn't defined.  Each vendor can choose different schemes, and they do.<br>
<br>
Back to you doing it wrong.<br>
<br>
You're defining an object interface.  That interface fronts a whole lot of code, and as you know, you really should be using a factory to instantiate your objects.  So check this out.  It's an interface that's exported from a shared lib to be used by a C++ program.<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br></code></pre></td>
<td class="source"><pre><code><var>namespace</var> kbw
{
    <var>class</var> Shape
    {
    <var>public</var>:
        <var>virtual</var> ~Shape() = 0;
        <var>virtual</var> <var>void</var> Render() = 0;
    };
}

<var>extern</var> <kbd>"C"</kbd>
{
    <var>typedef</var> kbw::Shape* kbw_shape_factory_t(<var>const</var> <var>char</var>* name);

    kbw::Shape* create_shape(<var>const</var> <var>char</var>* name);
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
The C++ user of this can write:<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br></code></pre></td>
<td class="source"><pre><code><dfn>#include &lt;kbw/Shape.hpp&gt;</dfn>
<dfn>#include &lt;memory&gt;</dfn>

<var>int</var> main()
{
    <var>if</var> (<var>void</var>* hModule = dlopen(<kbd>"kbwShapes"</kbd>, RTLD_NOW))
    {
        <var>if</var> (kbw_shape_factory_t* create = (kbw_shape_factory_t*)dlsym(hModule, <kbd>"create_shape"</kbd>))
        {
            unique_ptr&lt;kbw::Shape&gt; circle(create(<kbd>"circle"</kbd>));
            circle.get()-&gt;Render();

            unique_ptr&lt;kbw::Shape&gt; square(create(<kbd>"square"</kbd>));
            square.get()-&gt;Render();
        }

        dlclose(hModule);
    }
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Got it?
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm87d5fded4e" title="Thu, 11 Feb 2016 10:43:05 +0000"></span><script type="text/javascript">WhenId('CH_zTm87d5fded4e');</script><noscript>Feb 11, 2016 at 10:43am UTC</noscript></span>
<span class="dbtn" id="CH_btn901369"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg901390"><span title="901390,48752,1023,15,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg901390" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm25a31d9e02" title="Thu, 11 Feb 2016 12:19:29 +0000"></span><script type="text/javascript">WhenId('CH_zTm25a31d9e02');</script><noscript>Feb 11, 2016 at 12:19pm UTC</noscript></div>
<div class="dwho"><a href="/user/phoenix911/"><b>phoenix911</b> (15)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i901390">
Thanks a lot! Unfortunally I'm unable to use "code" etc buttons, since it doesn't work for some reason on my OpenSuSE Leap 42.1 with Firefox(latest version).<br>
<br>
I'd like to ask for one more help. Question is, that let's say we have that shape library (.so). And we have executable, that links it over dlsym. Now let's imagine we have one more lib, that the same way dlsyms shape library. I tried using static pointer to avoid recreation of class, but it woks only per one file(either additional lib, or executable), but not on both of them. I tried declarid in Shape lib cpp file static pointer to class declaration and static int counter to count how many created. Generally, if already created, then should return pointer, instead of creating new object. Same story with deletion.<br>
<br>
So the question is, if I add some more library that dlsym shape lib and executable that dlsym both libs to get one object for both of them(one copy of Share class), is that possible? And if it is, then how to do that? 
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn901390"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902143"><span title="902143,49329,1023,6375,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902143" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmf4eac2201d" title="Sun, 14 Feb 2016 11:39:23 +0000"></span><script type="text/javascript">WhenId('CH_zTmf4eac2201d');</script><noscript>Feb 14, 2016 at 11:39am UTC</noscript></div>
<div class="dwho"><a href="/user/Moschops/"><b>Moschops</b> (6375)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902143">
As an aside, is this being done for the learning experience, or do you have an actual need to not link in the normal fashion?
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn902143"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902150"><span title="902150,111189,1023,4867,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902150" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmb18d09f728" title="Sun, 14 Feb 2016 12:03:15 +0000"></span><script type="text/javascript">WhenId('CH_zTmb18d09f728');</script><noscript>Feb 14, 2016 at 12:03pm UTC</noscript></div>
<div class="dwho"><a href="/user/keskiverto/"><b>keskiverto</b> (4867)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902150">
<table class="quote"><tr><td class="qd">Unfortunally I'm unable to use "code" etc buttons, since it doesn't work for some reason on my OpenSuSE Leap 42.1 with Firefox(latest version).</td></tr></table><br>
You can always write the tags.<br>
The tag word is within brackets []<br>
The opening tag has word and the closing tag has /word.<br>
The word for code is "code".<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn902150"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg902225"><span title="902225,48752,1023,15,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg902225" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm7b56840b6a" title="Sun, 14 Feb 2016 18:14:57 +0000"></span><script type="text/javascript">WhenId('CH_zTm7b56840b6a');</script><noscript>Feb 14, 2016 at 6:14pm UTC</noscript></div>
<div class="dwho"><a href="/user/phoenix911/"><b>phoenix911</b> (15)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i902225">
I'm learning for myself new methods and will need it for own projects. Reason of not linking it ordinary way is a module system, that will be frequently updated partly and I wanna avoid recompilations etc cauze any single variable change/add. If you meant if that's some part of university task or something, then it's not. It's for personal use and personal project :-)
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn902225"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Registered users can post here. <a href="/user/">Sign in or register</a> to post.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(184342,0,48752,0,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li><a href="/forum/windows/"><b>Windows Programming</b></a></li><li class="selected"><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Funices%2F184342%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>