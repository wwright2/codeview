<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Smart pointers - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/general/">General C++ Programming</a></li>
<li class="here">Smart pointers</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico default" title="post">&nbsp;</div> Smart pointers</h3><span id="CH_edttl"></span><span class="rootdatPost" title="185252,root,0,-1,12,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg904658"><span title="904658,107125,1023,260,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904658" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm0f472525aa" title="Tue, 23 Feb 2016 11:10:46 +0000"></span><script type="text/javascript">WhenId('CH_zTm0f472525aa');</script><noscript>Feb 23, 2016 at 11:10am UTC</noscript></div>
<div class="dwho"><a href="/user/Kubani/"><b>Kubani</b> (260)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904658">
Hi,<br>
<br>
Please have a look at the code below. Is this a <i>smart pointer</i>?<br>
If so, why the first object, <span class="auto"><code class="source">p1</code></span>, is dangling at the end of the code? (That is <span class="auto"><code class="source">p2</code></span> is deleted by the <span class="auto"><code class="source">destructor</code></span> but <span class="auto"><code class="source">p1</code></span> remains, why?)<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br></code></pre></td>
<td class="source"><pre><code><dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include &lt;vector&gt;</dfn>
<var>using</var> <var>namespace</var> std;

<var>template</var> &lt;<var>class</var> T&gt; <var>class</var> my_auto_ptr {
	T* myptr;

<var>public</var>:
	my_auto_ptr(T* ptr = 0) : myptr(ptr) { }

	~my_auto_ptr() {
		<var>delete</var> myptr;
	}

	T* <var>operator</var> -&gt;() <var>const</var> {
		<var>if</var> (myptr != <var>nullptr</var>)  <var>return</var> myptr;
		<var>else</var> <var>throw</var> runtime_error(<kbd>""</kbd>);
	}
	T&amp; <var>operator</var>* () <var>const</var> {
		<var>if</var> (myptr != <var>nullptr</var>)  <var>return</var> *myptr;
		<var>else</var> <var>throw</var> runtime_error(<kbd>""</kbd>);
	}
	T* release() {
		T* rptr = myptr;
		myptr = 0;
		<var>return</var> rptr;
	}
};

<cite>//----------------------------------</cite>

<var>int</var> main() <var>try</var> {
	my_auto_ptr&lt;vector&lt;<var>int</var>&gt; &gt; p1(<var>new</var> vector&lt;<var>int</var>&gt;(4, 5));
	cout &lt;&lt; p1-&gt;size() &lt;&lt; endl;

	my_auto_ptr&lt;<var>int</var>&gt; p2(<var>new</var> <var>int</var>(6));
	cout &lt;&lt; *p2 &lt;&lt; endl;
	
	<var>return</var> 0;
}

<cite>//-------------------------------</cite>

<var>catch</var> (...) {
	cerr &lt;&lt; <kbd>"Exception occurred.\n"</kbd>;
	<var>return</var> 1;
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm7c19bfbd56" title="Tue, 23 Feb 2016 11:14:22 +0000"></span><script type="text/javascript">WhenId('CH_zTm7c19bfbd56');</script><noscript>Feb 23, 2016 at 11:14am UTC</noscript></span>
<span class="dbtn" id="CH_btn904658"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904660"><span title="904660,72446,1023,7402,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904660" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm80af07e5c7" title="Tue, 23 Feb 2016 11:16:58 +0000"></span><script type="text/javascript">WhenId('CH_zTm80af07e5c7');</script><noscript>Feb 23, 2016 at 11:16am UTC</noscript></div>
<div class="dwho"><a href="/user/Peter87/"><b>Peter87</b> (7402)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904660">
<table class="quote"><tr><td class="qd">If so, why the first object, p1, is dangling at the end of the code? (That is p2 is deleted by the destructor but p1 remains, why?)</td></tr></table><br>
What makes you think this is the case?
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904660"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904668"><span title="904668,199131,1023,610,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904668" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm3f9da80fd1" title="Tue, 23 Feb 2016 12:08:40 +0000"></span><script type="text/javascript">WhenId('CH_zTm3f9da80fd1');</script><noscript>Feb 23, 2016 at 12:08pm UTC</noscript></div>
<div class="dwho"><a href="/user/Thomas1965/"><b>Thomas1965</b> (610)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904668">
I think it has sth. do to with scope. If you wrap the code with the pointer in their own block they will get out of scope before main end.<br>
<br>
Try this:<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br></code></pre></td>
<td class="source"><pre><code><dfn>#include &lt;iostream&gt;</dfn>
<dfn>#include &lt;vector&gt;</dfn>
<var>using</var> <var>namespace</var> std;

<var>template</var> &lt;<var>class</var> T&gt; <var>class</var> my_auto_ptr
{
  T* myptr;

<var>public</var>:
  my_auto_ptr (T* ptr = 0) : myptr (ptr) { }

  ~my_auto_ptr () 
  {
    cout &lt;&lt; <kbd>"\n** my_auto_ptr::~my_auto_ptr() **"</kbd>;
    <var>delete</var> myptr;
  }

  T* <var>operator</var> -&gt;() <var>const</var> 
  {
    <var>if</var> (myptr != <var>nullptr</var>)  <var>return</var> myptr;
    <var>else</var> <var>throw</var> runtime_error (<kbd>""</kbd>);
  }
  T&amp; <var>operator</var>* () <var>const</var> 
  {
    <var>if</var> (myptr != <var>nullptr</var>)  <var>return</var> *myptr;
    <var>else</var> <var>throw</var> runtime_error (<kbd>""</kbd>);
  }
  T* release () 
  {
    T* rptr = myptr;
    myptr = 0;
    <var>return</var> rptr;
  }
};

<cite>//----------------------------------</cite>

<var>int</var> main () 
{
  <var>try</var>
  {
    {
      my_auto_ptr&lt;vector&lt;<var>int</var>&gt; &gt; p1 (<var>new</var> vector&lt;<var>int</var>&gt; (4, 5));
      cout &lt;&lt; p1-&gt;size () &lt;&lt; endl;

      my_auto_ptr&lt;<var>int</var>&gt; p2 (<var>new</var> <var>int</var> (6));
      cout &lt;&lt; *p2 &lt;&lt; endl;
    }
    system (<kbd>"pause"</kbd>);
    <var>return</var> 0;
  }
  <var>catch</var> (...)
  {
    cerr &lt;&lt; <kbd>"Exception occurred.\n"</kbd>;
    system (<kbd>"pause"</kbd>);
    <var>return</var> 1;
  }  
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904668"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904677"><span title="904677,49329,1023,6375,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904677" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm4be8b99867" title="Tue, 23 Feb 2016 13:06:45 +0000"></span><script type="text/javascript">WhenId('CH_zTm4be8b99867');</script><noscript>Feb 23, 2016 at 1:06pm UTC</noscript></div>
<div class="dwho"><a href="/user/Moschops/"><b>Moschops</b> (6375)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904677">
Your question makes no sense. <br>
<br>
Both of your custom <b>my_auto_ptr</b> type objects are destructored. In doing so, both of them call delete on the objects you created with new.<br>
<br>
As Peter asked, why do you think this isn't happening?
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904677"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904679"><span title="904679,199131,1023,610,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904679" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm6501c7411b" title="Tue, 23 Feb 2016 13:13:11 +0000"></span><script type="text/javascript">WhenId('CH_zTm6501c7411b');</script><noscript>Feb 23, 2016 at 1:13pm UTC</noscript></div>
<div class="dwho"><a href="/user/Thomas1965/"><b>Thomas1965</b> (610)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904679">
@Moschops,<br>
<br>
did you run his code?<br>
<br>
When I ran it on my VS 2013 CE the destructor's were not called - added a cout statement in his destructor.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904679"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904683"><span title="904683,127684,1023,57,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904683" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm0533c55624" title="Tue, 23 Feb 2016 13:32:33 +0000"></span><script type="text/javascript">WhenId('CH_zTm0533c55624');</script><noscript>Feb 23, 2016 at 1:32pm UTC</noscript></div>
<div class="dwho"><a href="/user/fcantoro/"><b>fcantoro</b> (57)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904683">
On my VS2015 the destructor is called as expected for both pointers.<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904683"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904909"><span title="904909,107125,1023,260,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904909" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmae38de0884" title="Wed, 24 Feb 2016 06:53:14 +0000"></span><script type="text/javascript">WhenId('CH_zTmae38de0884');</script><noscript>Feb 24, 2016 at 6:53am UTC</noscript></div>
<div class="dwho"><a href="/user/Kubani/"><b>Kubani</b> (260)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904909">
@Thomas1965: Yes, I agree.<br>
And to me it's not a smart pointer enough, because we need to add a block for every pointer we create.<br>
My compiler is MS VS 2015. And I ran the code through "Run To Cursor" mode.<br>
Thanks to all. 
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904909"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904914"><span title="904914,130771,1023,125,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904914" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm4f304e5e19" title="Wed, 24 Feb 2016 07:48:41 +0000"></span><script type="text/javascript">WhenId('CH_zTm4f304e5e19');</script><noscript>Feb 24, 2016 at 7:48am UTC</noscript></div>
<div class="dwho"><a href="/user/Little_Captain/"><b>Little Captain</b> (125)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904914">
Best way to find out if you're destructor is being called for both objects? <br>
<br>
Do this:<br>
<br>
Add a cout statement saying "Destructing auto_ptr" inside your destructor.  Next, run your program from the COMMAND PROMPT in windows.  This console won't close and you'll get to see the destructor output.  You should see two destructor lines, indicating that it was called twice - once for each auto_ptr.<br>
<br>
Try it.<br>
<br>
Joe<br>
Concord Spark Tutor<br>
sparkprogrammer@gmail.com
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904914"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904938"><span title="904938,39415,1023,5467,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904938" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm68f1e5f032" title="Wed, 24 Feb 2016 10:16:52 +0000"></span><script type="text/javascript">WhenId('CH_zTm68f1e5f032');</script><noscript>Feb 24, 2016 at 10:16am UTC</noscript></div>
<div class="dwho"><a href="/user/coder777/"><b>coder777</b> (5467)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904938">
@Thomas1965<br>
<br>
I cannot imagine that such a basic C++ concept like destructor doesn't work correctly with any recent compiler (including VS 2013).
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904938"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904943"><span title="904943,199131,1023,610,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904943" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm2d4ab26486" title="Wed, 24 Feb 2016 10:37:22 +0000"></span><script type="text/javascript">WhenId('CH_zTm2d4ab26486');</script><noscript>Feb 24, 2016 at 10:37am UTC</noscript></div>
<div class="dwho"><a href="/user/Thomas1965/"><b>Thomas1965</b> (610)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904943">
@coder777,<br>
<br>
I didn't say that it didn't work. I meant that when it went out of scope there that the console was closed already. That's the reason why I added the additional scope to see a result. When using a logfile it clearly show that both destructors were called.<br>
Sorry if I was not clear enough, but English is not my native language.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904943"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg904952"><span title="904952,39415,1023,5467,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg904952" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm013ef0596c" title="Wed, 24 Feb 2016 11:49:38 +0000"></span><script type="text/javascript">WhenId('CH_zTm013ef0596c');</script><noscript>Feb 24, 2016 at 11:49am UTC</noscript></div>
<div class="dwho"><a href="/user/coder777/"><b>coder777</b> (5467)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i904952">
The fundamental concept of C++ is that the destructor is called when an object falls out of the scope where the constructor is called.<br>
<br>
That means when an exception arise during or before the constructor is called the destructor isn't called either. Thus it is possible due to an exception that the destructor is not called.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn904952"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905179"><span title="905179,107125,1023,260,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905179" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm6cc3b7d90d" title="Thu, 25 Feb 2016 08:29:25 +0000"></span><script type="text/javascript">WhenId('CH_zTm6cc3b7d90d');</script><noscript>Feb 25, 2016 at 8:29am UTC</noscript></div>
<div class="dwho"><a href="/user/Kubani/"><b>Kubani</b> (260)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905179">
You guys, are right. I added the <span class="auto"><code class="source">system (<kbd>"pause"</kbd>);</code></span> inside the <i>destructor</i>'s body and it showed that the <i>destructor</i> was called for both <i>pointers</i>. Even when I created another object, for this one too, the <i>destructor</i> was called. And also there is no need to add any redundant blocks.  <br>
Apparently we cannot only rely on the "Run To Cursor" feature for seeing what is happening. Thanks. 
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905179"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Registered users can post here. <a href="/user/">Sign in or register</a> to post.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(185252,0,107125,0,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li><a href="/forum/windows/"><b>Windows Programming</b></a></li><li><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li class="selected"><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Fgeneral%2F185252%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>