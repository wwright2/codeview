<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>How to I clean up my code? It's a mess!  - C++ Forum (Page 2)</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/general/">General C++ Programming</a></li>
<li><a href="/forum/general/184609/">How to I clean up my code? It's a mess! </a></li>
<li class="here">Page 2</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico default" title="post">&nbsp;</div> How to I clean up my code? It's a mess! I can't even develop it further. </h3><span id="CH_edttl"></span><div class="C_pages">Pages: <a href="/forum/general/184609/1/">1</a><span title="Current page">2</span></div><span class="rootdatPost" title="184609,root,0,-1,34,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg903473"><span title="903473,119143,1023,310,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903473" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm86ce4c5115" title="Fri, 19 Feb 2016 03:45:45 +0000"></span><script type="text/javascript">WhenId('CH_zTm86ce4c5115');</script><noscript>Feb 19, 2016 at 3:45am UTC</noscript></div>
<div class="dwho"><a href="/user/RealGiganitris/"><b>RealGiganitris</b> (310)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903473">
Thanks for all the help, wow. I'll give sourcenav a try if it's in my repositories. I'll definitely give the facade method a try. I'll try to figure getopt() out. I'll consider using the llvm utilities, but why is early compliance with the newest version so important? I like the idea of stability in the binaries, when I'm programming. Wouldn't trying to run C++ 17 too early cause issues i.e. unknown bugs?<br>
<br>
EDIT:<br>
<table class="quote"><tr><td class="qd">I like to chat with you! ^^</td></tr></table><br>
If both of you are on at the same time, and you find a way to PM each other, you could use this websites IRC channel on freenode. I honestly didn't know we had a channel until I found it on Google. The website is freenode.net and the channel is #cplusplus.com. 
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm1df2670409" title="Fri, 19 Feb 2016 03:48:48 +0000"></span><script type="text/javascript">WhenId('CH_zTm1df2670409');</script><noscript>Feb 19, 2016 at 3:48am UTC</noscript></span>
<span class="dbtn" id="CH_btn903473"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg903478"><span title="903478,88654,1023,4208,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903478" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm9634c99e97" title="Fri, 19 Feb 2016 04:14:04 +0000"></span><script type="text/javascript">WhenId('CH_zTm9634c99e97');</script><noscript>Feb 19, 2016 at 4:14am UTC</noscript></div>
<div class="dwho"><a href="/user/TheIdeasMan/"><b>TheIdeasMan</b> (4208)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903478">
<table class="quote"><tr><td class="qd">I'll give sourcenav a try if it's in my repositories.</td></tr></table><br>
<br>
Consider some of the IDE's as well.<br>
<br>
<table class="quote"><tr><td class="qd">I'll definitely give the facade method a try.</td></tr></table><br>
<br>
Not sure why one would try to emulate OOP with C, why not just use C++ in that scenario? There is much more to OOP than just inheritance and function overloading. The "overhead" of C++ may not be as bad as you think: The STL in C++ is supposed to be zero overhead. Sure I can understand that there will be a bit of overhead as soon as one adds classes (vtables etc.) but it shouldn't be that bad.<br>
<br>
<table class="quote"><tr><td class="qd">I'll consider using the llvm utilities, but why is early compliance with the newest version so important? </td></tr></table><br>
<br>
It isn't really. Just that with some compilers (notably MSVC) there was a huge delay (~3 years) before they were C++11 compliant. Apparently they still have bugs with some of the C++11 stuff. As mentioned earlier, they are much better now with their progress towards C++17. But that is irrelevant for you on Linux with gcc. gcc has been pretty good at early compliance too. It's just that one might as well have the most up to date compiler if it's easy to get it.<br>
<br>
<table class="quote"><tr><td class="qd">I like the idea of stability in the binaries, when I'm programming. Wouldn't trying to run C++ 17 too early cause issues i.e. unknown bugs?</td></tr></table><br>
<br>
Well some of their stuff is still experimental at the moment, but they are careful to say what the status is. So once they say it is OK for use, then it will be. I am pretty sure they have a good reputation in that regard. You can still choose which release version you want, and you don't <i>have to</i> use a C++17 feature if you don't want to.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn903478"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg903541"><span title="903541,127909,1023,2072,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903541" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm289b9faf4f" title="Fri, 19 Feb 2016 12:25:12 +0000"></span><script type="text/javascript">WhenId('CH_zTm289b9faf4f');</script><noscript>Feb 19, 2016 at 12:25pm UTC</noscript></div>
<div class="dwho"><a href="/user/dhayden/"><b>dhayden</b> (2072)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903541">
<table class="quote"><tr><td class="qd">The STL in C++ is supposed to be zero overhead.</td></tr></table><br>
It's zero overhead compared to a hand-coded version of the same thing. The problem is that it's so convenient that it is often used when a much smaller and faster alternative exists. I would have to dig, but I posted an example a few months ago where one proposed solution generated about 15 kbytes of code and a simpler solution was less than 1 kbyte.<br>
<br>
It is no doubt true that memory is cheap and size doesn't matter as much as correctness, but there are plenty of applications on small devices where memory is tight.  I think it's important for programmers to know the cost of handy solutions.<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn903541"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg903549"><span title="903549,127909,1023,2072,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903549" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm7aaf51aa4b" title="Fri, 19 Feb 2016 13:57:48 +0000"></span><script type="text/javascript">WhenId('CH_zTm7aaf51aa4b');</script><noscript>Feb 19, 2016 at 1:57pm UTC</noscript></div>
<div class="dwho"><a href="/user/dhayden/"><b>dhayden</b> (2072)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903549">
Get rid of global "saving" flag. First, it shouldn't be a global. Second, You can determine if you're saving by whether safefile is open (initialize it to nullptr).  Never use two variables to mean the same thing: it opens you up to a bug by having then set inconsistently.<br>
<br>
IfileSize is never used. That means GetIfileSize() is not needed.<br>
<br>
Doing a bunch of strcmps in op for every single character processed is very expensive. Instead, create an enum to represent the operations and use a switch statement in op(). This will be very fast. The main program can convert from the operand string to the enum.<br>
<br>
This is a filter. Ideally it should read and write from cin/cout rather than requiring the user to specify file names.  The big advantage of reading/writing cin/cout is that you can read/write from a pipe.<br>
<br>
Here is a version cleaned up a little:<br>
- command line options handled a little more cleanly<br>
- loadfile/savefile are very similar <br>
- comments<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>153<br>154<br>155<br>156<br>157<br>158<br>159<br>160<br>161<br>162<br>163<br>164<br>165<br>166<br>167<br>168<br>169<br>170<br>171<br>172<br>173<br>174<br>175<br>176<br>177<br>178<br>179<br>180<br>181<br>182<br>183<br>184<br>185<br>186<br>187<br>188<br>189<br>190<br>191<br>192<br>193<br>194<br>195<br>196<br>197<br>198<br>199<br>200<br>201<br>202<br>203<br>204<br>205<br>206<br>207<br>208<br>209<br>210<br>211<br>212<br>213<br>214<br>215<br>216<br>217<br>218<br>219<br>220<br>221<br>222<br>223<br>224<br>225<br>226<br></code></pre></td>
<td class="source"><pre><code><dfn>#include&lt;cmath&gt;</dfn>
<dfn>#include&lt;cstdio&gt;</dfn>
<dfn>#include&lt;cstdlib&gt;</dfn>
<dfn>#include&lt;cstdint&gt;</dfn>
<dfn>#include&lt;cstring&gt;</dfn>
<dfn>#include&lt;fstream&gt;</dfn>
<dfn>#include &lt;errno.h&gt;</dfn>
<dfn>#include &lt;string&gt;</dfn>
<dfn>#include &lt;unistd.h&gt;</dfn>

<var>using</var> std::string;

<cite>// WARNING: If you change this enum you must also change operStrings below</cite>
<var>enum</var> Oper {add, subtract, multiply, divide, Random, XOR, AND, OR, NOT, MOD};

<cite>// Names of the opers. WARNING: These must correspond 1-1 with the Oper's above</cite>
<var>static</var> <var>const</var> <var>char</var> * operStrings[] = {
    <kbd>"add"</kbd>, <kbd>"sub"</kbd>, <kbd>"mul"</kbd>, <kbd>"div"</kbd>, <kbd>"ran"</kbd>, <kbd>"xor"</kbd>, <kbd>"and"</kbd>, <kbd>"or"</kbd>, <kbd>"not"</kbd>, <kbd>"mod"</kbd>,
    <var>nullptr</var>
};


FILE *ifile;
FILE *ofile;

<cite>// Just like fopen() but it prints a message to stdout on error</cite>
FILE *myfopen(<var>const</var> <var>char</var> *name, <var>const</var> <var>char</var> *mode)
{
    FILE *result = fopen(name, mode);
    <var>if</var> (result == <var>nullptr</var>) {
        printf(<kbd>"Can't open %s: %s\n"</kbd>, name, strerror(errno));
    }
    <var>return</var> result;
}


<var>void</var>
errormsg()
{
    printf(<kbd>"%s"</kbd>, <kbd>"Syntax error. Syntax is:\n"</kbd>);
    printf(<kbd>"%s"</kbd>,
           <kbd>"corrupt [switches] &lt;ifile&gt; &lt;ofile&gt; &lt;start&gt; &lt;stop&gt; &lt;every&gt; &lt;operation&gt; &lt;additional&gt;\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"ifile is the path to the input file.\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"ofile is the path to the output file.\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"start is the position in the file to start corrupting.\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"stop is the position in the file to stop corrupting.\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"every is the frequency of memory to ignore.\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"Operations:\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"add   Adds current byte to addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"sub   Subtracts current byte from addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"mul   Multiplies current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"div   Divides current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"mod   Modular current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"xor   Xor's current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"and   And's current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>" or   Or's current byte by addative\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"ran   Randomizes current byte\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"not   Not's current byte\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"Switches:\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"-l [file]     Load corruption from file\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"-v            Output corruptor version\n"</kbd>);
    printf(<kbd>"%s"</kbd>, <kbd>"-s [file]     Save corruption to file\n"</kbd>);

    exit(1);
}

<var>enum</var> Oper getOper(<var>const</var> string &amp;str)
{
    <var>for</var> (<var>int</var> i=0; operStrings[i]; ++i) {
        <var>if</var> (str == operStrings[i]) {
            <var>return</var> (Oper)i;
        }
    }
    printf(<kbd>"%s is not a valid operation string\n"</kbd>, str.c_str());
    exit(1);
}

<var>char</var>
op(<var>enum</var> Oper oper, <var>char</var> a, <var>char</var> b)
{
    <var>switch</var>(oper) {
    <var>case</var> add:
        <var>return</var> a + b;
        <var>break</var>;
    <var>case</var> subtract:
        <var>return</var> a - b;
        <var>break</var>;
    <var>case</var> multiply:
        <var>return</var> a * b;
        <var>break</var>;
    <var>case</var> divide:
        <var>return</var> a / b;
        <var>break</var>;
    <var>case</var> Random:
        <var>return</var> rand() % 128 - 64;
        <var>break</var>;
    <var>case</var> XOR:
        <var>return</var> a xor b;
        <var>break</var>;
    <var>case</var> AND:
        <var>return</var> a and b;
        <var>break</var>;
    <var>case</var> OR:
        <var>return</var> a or b;
        <var>break</var>;
    <var>case</var> NOT:
        <var>return</var> not(a);
        <var>break</var>;
    <var>case</var> MOD:
        <var>return</var> a % b;
        <var>break</var>;
    }
    <var>return</var> 0;                   <cite>// should not be reached.</cite>
}


<cite>// Corrupt every nth byte in ifile from strt to stop by changing the byte to</cite>
<cite>// byte &lt;oper&gt; operand</cite>
<var>void</var>
corrupt(<var>unsigned</var> <var>long</var> <var>long</var> <var>int</var> start, <var>unsigned</var> <var>long</var> <var>long</var> <var>int</var> stop,
        <var>unsigned</var> <var>int</var> n, <var>enum</var> Oper oper, <var>char</var> operand)
{
    <var>unsigned</var> <var>long</var> <var>long</var> <var>int</var> dimX = 0;
    <var>unsigned</var> <var>int</var> FreqCounter = 0;
    <var>int</var> regbyte;
    <var>while</var> ((regbyte = fgetc(ifile)) != EOF)      <cite>//While we haven't reached the end of the file...</cite>
    {
        <var>if</var> ((FreqCounter &gt;= n) and((dimX &gt;= start) and(dimX &lt;= stop)))  <cite>//And the conditions are juuust right...</cite>
        {
            regbyte = op(oper, regbyte, operand);
            putc(regbyte, ofile);
            FreqCounter = 0;                     <cite>//corrupt dat byte!</cite>
        } <var>else</var> {
            putc(regbyte, ofile);
        }                                        <cite>//Or don't...</cite>
        FreqCounter = FreqCounter + 1;
        dimX = dimX + 1;                         <cite>//counting</cite>
    }
    printf(<kbd>"%s"</kbd>, <kbd>"The file seems to have been successfully corrupted...\n"</kbd>);
}

<var>int</var>
main(<var>int</var> argc, <var>char</var> *argv[])
{
    string opString;
    std::ofstream savefile;
    std::ifstream loadfile;
    <var>int</var> op;

    <cite>// These are arguments to corrupt</cite>
    <var>unsigned</var> <var>long</var> <var>long</var> start, stop;
    <var>unsigned</var> <var>int</var> frequency;
    <var>enum</var> Oper oper;
    <var>char</var> operand;

    <var>while</var> ((op = getopt(argc, argv, <kbd>"l:vs:"</kbd>)) != EOF) {
        <var>switch</var> (op) {
        <var>case</var> <kbd>'l'</kbd>:
            loadfile.open(optarg);
            <var>if</var> (!loadfile) {
                printf(<kbd>"Can't open %s\n"</kbd>, optarg);
                <var>return</var> 1;
            }
            <var>break</var>;
        <var>case</var> <kbd>'v'</kbd>:
            printf(<kbd>"%s"</kbd>, <kbd>"LAwl\n"</kbd>);
            <var>break</var>;
        <var>case</var> <kbd>'s'</kbd>:
            savefile.open(optarg);
            <var>if</var> (!savefile) {
                printf(<kbd>"Can't open %s\n"</kbd>, optarg);
                <var>return</var> 1;
            }
            <var>break</var>;
        <var>default</var>:
            errormsg();
        }
    }

    <var>if</var> (optind+2 &gt; argc) errormsg();

    <var>if</var> ((ifile = myfopen(argv[optind++], <kbd>"rb"</kbd>)) == <var>nullptr</var>) {
        <var>return</var> 1;
    }

    <var>if</var> ((ofile = myfopen(argv[optind++], <kbd>"wb"</kbd>)) == <var>nullptr</var>) {
        <var>return</var> 1;
    }


    <cite>// Now get the corruption options from the command</cite>
    <cite>// line or loadFile</cite>
    <var>if</var> (loadfile.is_open()) {
        <var>int</var> tmp;
        loadfile &gt;&gt; start &gt;&gt; stop &gt;&gt; frequency &gt;&gt; opString &gt;&gt; tmp;
        operand = tmp;
        oper = getOper(opString);
    } <var>else</var> {
        <var>if</var> (optind + 5 &gt; argc) {
            errormsg();
        }
        start = atoi(argv[optind++]);
        stop = atoi(argv[optind++]);
        frequency = atoi(argv[optind++]);
        oper = getOper(argv[optind++]);
        operand = atoi(argv[optind++]);
    }

    <cite>// Now you have all the options</cite>
    corrupt(start, stop, frequency, oper, operand);

    fclose(ifile);
    fclose(ofile);

    <var>if</var> (savefile.is_open()) {
        savefile &lt;&lt; start &lt;&lt; <kbd>'\n'</kbd>
                 &lt;&lt; stop &lt;&lt; <kbd>'\n'</kbd>
                 &lt;&lt; frequency &lt;&lt; <kbd>'\n'</kbd>
                 &lt;&lt; operStrings[(<var>int</var>)oper] &lt;&lt; <kbd>'\n'</kbd>
                 &lt;&lt; operand &lt;&lt; <kbd>'\n'</kbd>;
    }

    <var>return</var> 0;
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn903549"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg903578"><span title="903578,199131,1023,610,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg903578" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmb6c4eebffe" title="Fri, 19 Feb 2016 16:41:59 +0000"></span><script type="text/javascript">WhenId('CH_zTmb6c4eebffe');</script><noscript>Feb 19, 2016 at 4:41pm UTC</noscript></div>
<div class="dwho"><a href="/user/Thomas1965/"><b>Thomas1965</b> (610)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i903578">
@RealGiganitris<br>
What you want to accomplish is called Code Refactoring. It consists of many small steps. Have  alook at the wiki.<br>
<a href="https://en.wikipedia.org/wiki/Code_refactoring">https://en.wikipedia.org/wiki/Code_refactoring</a><br>
<br>
There is a excellent tutorial on NetTuts about it - though it's in PHP it might be useful.<br>
<a href="http://code.tutsplus.com/tutorials/refactoring-legacy-code-part-1-the-golden-master--cms-20331">http://code.tutsplus.com/tutorials/refactoring-legacy-code-part-1-the-golden-master--cms-20331</a>
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn903578"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905097"><span title="905097,119143,1023,310,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905097" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm846f7ce5b5" title="Thu, 25 Feb 2016 00:09:54 +0000"></span><script type="text/javascript">WhenId('CH_zTm846f7ce5b5');</script><noscript>Feb 25, 2016 at 12:09am UTC</noscript></div>
<div class="dwho"><a href="/user/RealGiganitris/"><b>RealGiganitris</b> (310)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905097">
I've been lucky enough to get a bit of free time. I'm nowhere near finished, but how's this? Better?<br>
<br>
main.cpp:<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br></code></pre></td>
<td class="source"><pre><code><dfn>#include&lt;cmath&gt;</dfn>
<dfn>#include&lt;cstdio&gt;</dfn>
<dfn>#include&lt;cstdlib&gt;</dfn>
<dfn>#include&lt;cstdint&gt;</dfn>
<dfn>#include&lt;cstring&gt;</dfn>
<dfn>#include"Portable.h"</dfn>
<var>char</var> version[16] = <kbd>"[A.1.3.2]"</kbd>;

<var>char</var>* Settings[8];	<cite>//Stores a POINTER to the user settings</cite>
<var>char</var> iputCa[8][32];
FILE* iputROM;
uint32_t iputROMsize;
FILE* oputROM;
FILE* iputC;
FILE* oputC;
uint32_t Start;
uint32_t Stop;
uint32_t Period;
<var>char</var> Additional;

<var>void</var> load_from_settings(){
<var>if</var>((iputROM = fopen(Settings[1],<kbd>"rb"</kbd>)) == NULL){perror(Settings[1]);exit(1);}	<cite>//Load the victim ROM file</cite>
<var>if</var>((oputROM = fopen(Settings[2],<kbd>"wb"</kbd>)) == NULL){perror(Settings[2]);exit(1);}	<cite>//Load the new ROM file</cite>
iputROMsize = GetFileSize(iputROM);			<cite>//Get the ROM file size for percentage calcs (not implemented)</cite>
Start = FormattedStringToInt(Settings[3]);		<cite>//Where to start</cite>
Stop =  FormattedStringToInt(Settings[4]);		<cite>//Where to stop</cite>
Period =  FormattedStringToInt(Settings[5]);		<cite>//Period (Reciprocal of the frequency)</cite>
Additional =  FormattedStringToInt(Settings[7]);	<cite>//Additional value for op(op doesn't need processing, that's why 6 is skipped)</cite>
}

<var>char</var> op(<var>char</var> opc){
<var>if</var>(strcmp(Settings[6], <kbd>"add"</kbd>) == 0){<var>return</var> opc+Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"sub"</kbd>) == 0){<var>return</var> opc-Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"mul"</kbd>) == 0){<var>return</var> opc*Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"div"</kbd>) == 0){<var>return</var> opc/Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"ran"</kbd>) == 0){<var>return</var> rand() % 128 -64;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"xor"</kbd>) == 0){<var>return</var> opc xor Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"and"</kbd>) == 0){<var>return</var> opc and Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"or"</kbd>) == 0){<var>return</var> opc or Additional;}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"not"</kbd>) == 0){<var>return</var> not(opc);}
<var>else</var> <var>if</var>(strcmp(Settings[6], <kbd>"mod"</kbd>) == 0){<var>return</var> opc % Additional;}
<var>else</var>{printf(<kbd>"Error 3 %s\n"</kbd>,Settings[6]);exit(1);}
}

<var>void</var> corrupt(){
uint32_t CdimX = 0;
uint16_t CFreqCounter = 0;
<var>int</var> Cregbyte;
<var>while</var>((Cregbyte = fgetc(iputROM)) != EOF){						<cite>//While we haven't reached the end of the file...</cite>
	<var>if</var>((CFreqCounter &gt;= Period) and ((CdimX &gt;= Start) and (CdimX &lt;= Stop))){	<cite>//And the conditions are juuust right...</cite>
		Cregbyte = op(Cregbyte);putc(Cregbyte, oputROM);CFreqCounter = 0;}	<cite>//corrupt dat byte!</cite>
	<var>else</var>{putc(Cregbyte, oputROM);}							<cite>//Or don't...</cite>
	CFreqCounter = CFreqCounter +1;CdimX = CdimX +1;}				<cite>//counting</cite>
perror(<kbd>""</kbd>);
}

<var>int</var> main(<var>int</var> argc, <var>char</var>* argv[])
{
uint8_t MainArgIndex = 1; 	<cite>//which argument to check</cite>
uint8_t MainArgSI;		<cite>//An index variable for the settings</cite>
<var>while</var>(MainArgIndex &lt; argc){	<cite>//Begin parsing CMD</cite>
MainArgSI = 1; 			<cite>//Restore Settings Indexer (so it can be reused)</cite>
<var>if</var>(strcmp(argv[MainArgIndex],<kbd>"-v"</kbd>) == 0){printf(<kbd>"%s\n"</kbd>, version);}		<cite>//Output version</cite>
<var>else</var> <var>if</var>(strcmp(argv[MainArgIndex],<kbd>"-s"</kbd>) == 0){					<cite>//Create corruption file</cite>
	<var>if</var>((argc-(MainArgIndex+1))&lt;0){printf(<kbd>"Error 2 %i %i\n"</kbd>,MainArgIndex,argc);exit(1);}			<cite>//Avoid seg fault</cite>
	<var>while</var>(MainArgSI != 2){Settings[MainArgSI] = argv[MainArgIndex +MainArgSI];MainArgSI = MainArgSI +1;}	<cite>//Load settings</cite>
	MainArgIndex = MainArgIndex +1; 									<cite>//Restore the cursor</cite>
	<var>if</var>((oputC = fopen(Settings[1],<kbd>"wb"</kbd>)) == NULL){perror(Settings[1]);exit(1);}	<cite>//Load the new file</cite>
	fputs(version,oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	fputs(IntToString(Start),oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	fputs(IntToString(Stop),oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	fputs(IntToString(Period),oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	fputs(Settings[6],oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	fputs(IntToString(Additional),oputC);
	fputs(<kbd>"\n"</kbd>,oputC);
	perror(<kbd>""</kbd>);
	<var>while</var>(fclose(oputC) == EOF){}	<cite>//Close the file as needed</cite>
	}	
<var>else</var> <var>if</var>(strcmp(argv[MainArgIndex],<kbd>"-l"</kbd>) == 0){					<cite>//Corrupt using a file</cite>
	<var>if</var>((argc-(MainArgIndex+3))&lt;0){printf(<kbd>"Error 2\n"</kbd>);exit(1);}	<cite>//Avoid seg fault</cite>
	<var>while</var>(MainArgSI != 4){Settings[MainArgSI] = argv[MainArgIndex +MainArgSI];MainArgSI = MainArgSI +1;}	<cite>//load settings</cite>
	MainArgIndex = MainArgIndex +3; 									<cite>//Restore the cursor</cite>
	<var>if</var>((iputC = fopen(Settings[1],<kbd>"rb"</kbd>)) == NULL){perror(Settings[1]);exit(1);}				<cite>//Load the instructions</cite>
	Settings[1] = Settings[2];
	Settings[2] = Settings[3];
	fgets(iputCa[1],256,iputC);
	fgets(iputCa[2],256,iputC);Settings[3] = iputCa[2];
	fgets(iputCa[3],256,iputC);Settings[4] = iputCa[3];
	fgets(iputCa[4],256,iputC);Settings[5] = iputCa[4];
	fgets(iputCa[5],256,iputC);iputCa[5][3] = <kbd>'\0'</kbd>;Settings[6] = iputCa[5];
	fgets(iputCa[6],256,iputC);Settings[7] = iputCa[6];
	load_from_settings();
	corrupt();
	<var>while</var>(fclose(iputROM) == EOF){}	<cite>//Close the files as needed</cite>
	<var>while</var>(fclose(oputROM) == EOF){}	<cite>//If you can't close the file, try again</cite>
	}
<var>else</var> <var>if</var>(strcmp(argv[MainArgIndex],<kbd>"-c"</kbd>) == 0){					<cite>//Corrupt using settings</cite>
	<var>if</var>((argc-(MainArgIndex+7))&lt;0){printf(<kbd>"Error 2\n"</kbd>);exit(1);}						<cite>//Avoid seg fault</cite>
	<var>while</var>(MainArgSI != 8){Settings[MainArgSI] = argv[MainArgIndex +MainArgSI];MainArgSI = MainArgSI +1;}	<cite>//load settings</cite>
	MainArgIndex = MainArgIndex +7; <cite>//Restore the cursor</cite>
	load_from_settings();		<cite>//Prepare for corruption</cite>
	corrupt();			<cite>//Corrupt</cite>
	<var>while</var>(fclose(iputROM) == EOF){}	<cite>//Close the files as needed</cite>
	<var>while</var>(fclose(oputROM) == EOF){}	<cite>//If you can't close the file, try again</cite>
	}
<var>else</var>{printf(<kbd>"Error 1\n"</kbd>);exit(1);}
MainArgIndex = MainArgIndex +1;
}
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Portable.h<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br></code></pre></td>
<td class="source"><pre><code><dfn>#include&lt;cstdint&gt;</dfn>
<dfn>#include&lt;cstdio&gt;</dfn>

int32_t GetFileSize(FILE* GetFileSizeFile){
int32_t getfilesizesize = 0;
fseek(GetFileSizeFile, 0L, SEEK_SET);
<var>while</var>(fgetc(GetFileSizeFile) != EOF){getfilesizesize = getfilesizesize +1;}
fseek(GetFileSizeFile, 0L, SEEK_SET);
<var>return</var> getfilesizesize;
}

int32_t FormattedStringToInt(<var>const</var> <var>char</var>* FStoIiS){
<cite>//This function will be built upon in the future</cite>
<var>return</var> strtol(FStoIiS, NULL, 0);
}

<var>char</var> IntToStrStr[256];
<var>const</var> <var>char</var>* IntToString(int64_t IntToStrInt){
sprintf(IntToStrStr,<kbd>"%d"</kbd>,IntToStrInt);
<var>return</var> IntToStrStr;
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905097"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905106"><span title="905106,37152,1023,8200,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905106" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm400311226d" title="Thu, 25 Feb 2016 01:29:57 +0000"></span><script type="text/javascript">WhenId('CH_zTm400311226d');</script><noscript>Feb 25, 2016 at 1:29am UTC</noscript></div>
<div class="dwho"><a href="/user/ne555/"><b>ne555</b> (8200)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905106">
at least bother to indent it.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905106"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905125"><span title="905125,127909,1023,2072,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905125" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmbb6784bd23" title="Thu, 25 Feb 2016 02:53:41 +0000"></span><script type="text/javascript">WhenId('CH_zTmbb6784bd23');</script><noscript>Feb 25, 2016 at 2:53am UTC</noscript></div>
<div class="dwho"><a href="/user/dhayden/"><b>dhayden</b> (2072)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905125">
Why do you have fclose() in a loop? If it fails once I don't think it will succeed the next time.<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905125"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905157"><span title="905157,119143,1023,310,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905157" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm6bf61b5b14" title="Thu, 25 Feb 2016 05:42:10 +0000"></span><script type="text/javascript">WhenId('CH_zTm6bf61b5b14');</script><noscript>Feb 25, 2016 at 5:42am UTC</noscript></div>
<div class="dwho"><a href="/user/RealGiganitris/"><b>RealGiganitris</b> (310)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905157">
What do you mean at least bother to indent it? What needs indenting? I've heard that fclose may fail sometimes, and that it's best to have it in a loop like that. I'll try to find the resource... 
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905157"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905164"><span title="905164,37152,1023,8200,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905164" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm5f0df3067c" title="Thu, 25 Feb 2016 06:40:36 +0000"></span><script type="text/javascript">WhenId('CH_zTm5f0df3067c');</script><noscript>Feb 25, 2016 at 6:40am UTC</noscript></div>
<div class="dwho"><a href="/user/ne555/"><b>ne555</b> (8200)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905164">
<div class="auto"><table class="snippet"><tr><td class="output"><pre><samp>$ dict indent
&lt;text, programming&gt; Space and/or {tab} characters added at the beginning of a
line to indicate structure, e.g. indenting a quotation to make it stand out or
indenting a {block} of code controlled by an {if statement}.

Indentation is important in {source code} for readability.  There are a number
of different {indent styles}.  Some programming languages go further and use
indentation as the main method to represent block structure to the {compiler}
or {interpreter}, see {off-side rule}.</samp></pre></td></tr></table></div><br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905164"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905167"><span title="905167,88654,1023,4208,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905167" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmdb92137ef8" title="Thu, 25 Feb 2016 07:06:10 +0000"></span><script type="text/javascript">WhenId('CH_zTmdb92137ef8');</script><noscript>Feb 25, 2016 at 7:06am UTC</noscript></div>
<div class="dwho"><a href="/user/TheIdeasMan/"><b>TheIdeasMan</b> (4208)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905167">
<table class="quote"><tr><td class="qd">What do you mean at least bother to indent it? What needs indenting? </td></tr></table><br>
<br>
Well, all of it. As mentioned earlier, have a go with a code formatter: Astyle or llvm-format for example. You could do with more vertical white space, white space around operators, avoid several statements on 1 line, indent block statements.<br>
<br>
This program is probably too small to warrant splitting up, but if you figure out how to do this, then you will know what to do when your code base gets a little larger - like 5000 LOC say :+)<br>
<br>
So you have started with more use of functions into a separate files, but you shouldn't have implementation code in header files. Just like C++ with classes, one has header files with declarations of functions,  then function implementations in the .c or .cpp files.  Should still have header guards, or <span class="auto"><code class="source"><dfn>#pragma once </dfn></code></span> maybe - it's not standard, but is widely supported by compilers.<br>
<br>
<table class="quote"><tr><td class="qd"><a href="https://en.wikipedia.org/wiki/Pragma_once">https://en.wikipedia.org/wiki/Pragma_once</a> <br>
</td></tr></table><br>
<br>
You could aim to not have any function definitions in main.cpp. Even for small programs, I like to put function definitions after main, purely so that main is at the top of the file.<br>
<br>
Do you have to have that many global variables? I know it's easy, but it is not usually a good sign.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905167"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905359"><span title="905359,119143,1023,310,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905359" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm223fc11c68" title="Thu, 25 Feb 2016 23:31:51 +0000"></span><script type="text/javascript">WhenId('CH_zTm223fc11c68');</script><noscript>Feb 25, 2016 at 11:31pm UTC</noscript></div>
<div class="dwho"><a href="/user/RealGiganitris/"><b>RealGiganitris</b> (310)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905359">
Yeah, all of them are necessary. The program will not run (properly without segfaults) otherwise. <br>
<br>
Also, all lines are indented for the contents of if statements, while loops and so on. What's missing?
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm13e65f4fbd" title="Thu, 25 Feb 2016 23:33:52 +0000"></span><script type="text/javascript">WhenId('CH_zTm13e65f4fbd');</script><noscript>Feb 25, 2016 at 11:33pm UTC</noscript></span>
<span class="dbtn" id="CH_btn905359"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905363"><span title="905363,78419,1023,7174,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905363" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTme7bfebb857" title="Thu, 25 Feb 2016 23:50:59 +0000"></span><script type="text/javascript">WhenId('CH_zTme7bfebb857');</script><noscript>Feb 25, 2016 at 11:50pm UTC</noscript></div>
<div class="dwho"><a href="/user/cire/"><b>cire</b> (7174)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905363">
By convention, only things at global scope should not be indented.  The contents of your functions are not at global scope, therefore they should be indented.<br>
<br>
I cannot look at your code and easily tell where your plethora of global variables end and your functions begin (or end.)
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn905363"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg905394"><span title="905394,88654,1023,4208,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg905394" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmfefcbb7012" title="Fri, 26 Feb 2016 03:44:29 +0000"></span><script type="text/javascript">WhenId('CH_zTmfefcbb7012');</script><noscript>Feb 26, 2016 at 3:44am UTC</noscript></div>
<div class="dwho"><a href="/user/TheIdeasMan/"><b>TheIdeasMan</b> (4208)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i905394">
<table class="quote"><tr><td class="qd">Yeah, all of them are necessary. The program will not run (properly without segfaults) otherwise.</td></tr></table><br>
<br>
Disagree, it should always be possible to re-factor so there are no global variables. You could start by declaring them in main, then send them as arguments to whatever function needs them. There might even be some that could be local to a function.<br>
<br>
<table class="quote"><tr><td class="qd">Also, all lines are indented for the contents of if statements, while loops and so on. What's missing? </td></tr></table><br>
<br>
You almost* get away with having the same indentation because you have multiple statements on 1 line.<br>
<br>
* The while loop on line 61 of main, everything in it should be indented one level.<br>
<br>
Right, so I ran your code through clang formatter, which I have in my IDE. I also put comments before code, not after. There were a number of places where I used <span class="auto"><code class="source">++a;</code></span> rather than <span class="auto"><code class="source">a =a +1;</code></span>, and a couple of <span class="auto"><code class="source">+=</code></span> operator. I also added a little bit more vertical white space.<br>
<br>
Also for some of the functions with no arguments, I made the parameter <span class="auto"><code class="source"><var>void</var></code></span>. This is because the code is essentially C, so that is a little defensive measure in case it is compiled as C one day.<br>
<br>
The <span class="auto"><code class="source"><var>else</var> <var>if</var></code></span> statements in main could call functions IMO, that would be much easier to read.<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>153<br>154<br>155<br>156<br>157<br>158<br>159<br>160<br>161<br>162<br>163<br>164<br>165<br>166<br>167<br>168<br>169<br>170<br>171<br>172<br>173<br>174<br>175<br>176<br>177<br>178<br>179<br>180<br>181<br>182<br>183<br>184<br>185<br>186<br>187<br>188<br>189<br>190<br>191<br>192<br>193<br>194<br>195<br>196<br>197<br>198<br>199<br>200<br>201<br>202<br>203<br>204<br>205<br>206<br>207<br>208<br>209<br>210<br>211<br>212<br>213<br>214<br>215<br>216<br>217<br>218<br>219<br>220<br>221<br>222<br>223<br>224<br>225<br>226<br>227<br>228<br>229<br></code></pre></td>
<td class="source"><pre><code><dfn>#include &lt;cmath&gt;</dfn>
<dfn>#include &lt;cstdio&gt;</dfn>
<dfn>#include &lt;cstdlib&gt;</dfn>
<dfn>#include &lt;cstdint&gt;</dfn>
<dfn>#include &lt;cstring&gt;</dfn>
<dfn>#include "Portable.h"</dfn>
<var>char</var> version[16] = <kbd>"[A.1.3.2]"</kbd>;

<var>char</var> *Settings[8]; <cite>// Stores a POINTER to the user settings</cite>
<var>char</var> iputCa[8][32];
FILE *iputROM;
uint32_t iputROMsize;
FILE *oputROM;
FILE *iputC;
FILE *oputC;
uint32_t Start;
uint32_t Stop;
uint32_t Period;
<var>char</var> Additional;


<var>void</var> load_from_settings(<var>void</var>); <cite>// Load the victim ROM file</cite>
<var>char</var> op(<var>char</var> opc);
<var>void</var> corrupt(<var>void</var>);

<var>int</var> main(<var>int</var> argc, <var>char</var> *argv[]) {
  uint8_t MainArgIndex = 1; <cite>// which argument to check</cite>
  uint8_t MainArgSI; <cite>// An index variable for the settings</cite>

  <cite>// Begin parsing CMD</cite>
  <var>while</var> (MainArgIndex &lt; argc) {
    MainArgSI = 1; <cite>// Restore Settings Indexer (so it can be reused)</cite>

    <cite>// Output version</cite>
    <var>if</var> (strcmp(argv[MainArgIndex], <kbd>"-v"</kbd>) == 0) {
      printf(<kbd>"%s\n"</kbd>, version);
    }
    <var>else</var> <var>if</var> (strcmp(argv[MainArgIndex], <kbd>"-s"</kbd>) == 0) { <cite>// Create corruption file</cite>

      <cite>// Avoid seg fault</cite>
      <var>if</var> ((argc - (MainArgIndex + 1)) &lt; 0) {
        printf(<kbd>"Error 2 %i %i\n"</kbd>, MainArgIndex, argc);
        exit(1);
      }

      <cite>// Load settings</cite>
      <var>while</var> (MainArgSI != 2) {
        Settings[MainArgSI] = argv[MainArgIndex + MainArgSI];
        ++MainArgSI;
      }

      ++MainArgIndex; <cite>// Restore the cursor</cite>

      <cite>// Load the new file</cite>
      <var>if</var> ((oputC = fopen(Settings[1], <kbd>"wb"</kbd>)) == NULL) {
        perror(Settings[1]);
        exit(1);
      }

      fputs(version, oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      fputs(IntToString(Start), oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      fputs(IntToString(Stop), oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      fputs(IntToString(Period), oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      fputs(Settings[6], oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      fputs(IntToString(Additional), oputC);
      fputs(<kbd>"\n"</kbd>, oputC);
      perror(<kbd>""</kbd>);

      <cite>// Close the file as needed</cite>
      <var>while</var> (fclose(oputC) == EOF) {
      }
    } <var>else</var> <var>if</var> ( strcmp(argv[MainArgIndex], <kbd>"-l"</kbd>) == 0 ) { <cite>// Corrupt using a file</cite>
      <cite>// Avoid seg fault</cite>
      <var>if</var> ((argc - (MainArgIndex + 3)) &lt; 0) {
        printf(<kbd>"Error 2\n"</kbd>);
        exit(1);
      }

      <cite>// load settings</cite>
      <var>while</var> (MainArgSI != 4) {
        Settings[MainArgSI] = argv[MainArgIndex + MainArgSI];
        ++MainArgSI;
      }
      MainArgIndex += 3; <cite>// Restore the cursor</cite>

      <cite>// Load the instructions</cite>
      <var>if</var> ( (iputC = fopen(Settings[1], <kbd>"rb"</kbd>) ) == NULL ) {
        perror(Settings[1]);
        exit(1);
      }

      Settings[1] = Settings[2];
      Settings[2] = Settings[3];
      fgets(iputCa[1], 256, iputC);
      fgets(iputCa[2], 256, iputC);
      Settings[3] = iputCa[2];
      fgets(iputCa[3], 256, iputC);
      Settings[4] = iputCa[3];
      fgets(iputCa[4], 256, iputC);
      Settings[5] = iputCa[4];
      fgets(iputCa[5], 256, iputC);
      iputCa[5][3] = <kbd>'\0'</kbd>;
      Settings[6] = iputCa[5];
      fgets(iputCa[6], 256, iputC);
      Settings[7] = iputCa[6];
      load_from_settings();
      corrupt();

      <cite>// Close the files as needed</cite>
      <var>while</var> (fclose(iputROM) == EOF) {
      }
      <cite>// If you can't close the file, try again</cite>
      <var>while</var> (fclose(oputROM) == EOF) {
      }

    } <var>else</var> <var>if</var> (strcmp(argv[MainArgIndex], <kbd>"-c"</kbd>) == 0) { <cite>// Corrupt using settings</cite>
      <cite>// Avoid seg fault</cite>
      <var>if</var> ((argc - (MainArgIndex + 7)) &lt; 0) {
        printf(<kbd>"Error 2\n"</kbd>);
        exit(1);
      }

      <cite>// load settings</cite>
      <var>while</var> (MainArgSI != 8) {
        Settings[MainArgSI] = argv[MainArgIndex + MainArgSI];
        ++MainArgSI;
      }

      MainArgIndex += 7; <cite>// Restore the cursor</cite>
      load_from_settings(); <cite>// Prepare for corruption</cite>
      corrupt(); <cite>// Corrupt</cite>

      <cite>// Close the files as needed</cite>
      <var>while</var> (fclose(iputROM) == EOF) {
      }
      <cite>// If you can't close the file, try again</cite>
      <var>while</var> (fclose(oputROM) == EOF) {
      }
    } <var>else</var> {
      printf(<kbd>"Error 1\n"</kbd>);
      exit(1);
    }
    MainArgIndex += 1;
  }
}

<var>void</var> corrupt(<var>void</var>) {
  uint32_t CdimX = 0;
  uint16_t CFreqCounter = 0;
  <var>int</var> Cregbyte;

  <cite>// While we haven't reached the end of the file...</cite>
  <var>while</var> ((Cregbyte = fgetc(iputROM)) !=EOF) {
    <cite>// And the conditions are juuust right...</cite>
    <var>if</var> ((CFreqCounter &gt;= Period) and
        ((CdimX &gt;= Start) and
         (CdimX &lt;= Stop))) {
      <cite>// corrupt dat byte!</cite>
      Cregbyte = op(Cregbyte);
      putc(Cregbyte, oputROM);
      CFreqCounter = 0;
    }
    <cite>// Or don't...</cite>
    <var>else</var> {
      putc(Cregbyte, oputROM);
    }
    <cite>// counting</cite>
    ++CFreqCounter;
    ++CdimX;
  }
  perror(<kbd>""</kbd>);
}

<var>char</var> op(<var>char</var> opc) {
  <var>if</var> (strcmp(Settings[6], <kbd>"add"</kbd>) == 0) {
    <var>return</var> opc + Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"sub"</kbd>) == 0) {
    <var>return</var> opc - Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"mul"</kbd>) == 0) {
    <var>return</var> opc * Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"div"</kbd>) == 0) {
    <var>return</var> opc / Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"ran"</kbd>) == 0) {
    <var>return</var> rand() % 128 - 64;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"xor"</kbd>) == 0) {
    <var>return</var> opc xor Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"and"</kbd>) == 0) {
    <var>return</var> opc and Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"or"</kbd>) == 0) {
    <var>return</var> opc or Additional;
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"not"</kbd>) == 0) {
    <var>return</var> not(opc);
  } <var>else</var> <var>if</var> (strcmp(Settings[6], <kbd>"mod"</kbd>) == 0) {
    <var>return</var> opc % Additional;
  } <var>else</var> {
    printf(<kbd>"Error 3 %s\n"</kbd>, Settings[6]);
    exit(1);
  }
}

<var>void</var> load_from_settings(<var>void</var>) {
  <var>if</var> ((iputROM = fopen(Settings[1], <kbd>"rb"</kbd>)) == NULL) {
    perror(Settings[1]);
    exit(1);
  }

  <cite>// Load the new ROM file</cite>
  <var>if</var> ((oputROM = fopen(Settings[2], <kbd>"wb"</kbd>)) == NULL) {
    perror(Settings[2]);
    exit(1);
  }

  <cite>// Get the ROM file size for percentage calcs (not implemented)</cite>
  iputROMsize = GetFileSize(iputROM);
  <cite>// Where to start</cite>
  Start = FormattedStringToInt(Settings[3]);
  <cite>// Where to stop</cite>
  Stop = FormattedStringToInt(Settings[4]);
  <cite>// Period (Reciprocal of the frequency)</cite>
  Period = FormattedStringToInt(Settings[5]);
  <cite>// Additional value for op(op doesn't need processing, that's why 6 is skipped)</cite>
  Additional = FormattedStringToInt(Settings[7]);

}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
<br>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmef4d0cdf02" title="Fri, 26 Feb 2016 03:54:32 +0000"></span><script type="text/javascript">WhenId('CH_zTmef4d0cdf02');</script><noscript>Feb 26, 2016 at 3:54am UTC</noscript></span>
<span class="dbtn" id="CH_btn905394"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Registered users can post here. <a href="/user/">Sign in or register</a> to post.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><div class="C_pages right">Pages: <a href="/forum/general/184609/1/">1</a><span title="Current page">2</span></div><script type="text/javascript">new for_PostList(184609,0,119143,0,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li><a href="/forum/windows/"><b>Windows Programming</b></a></li><li><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li class="selected"><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Fgeneral%2F184609%2F2%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>