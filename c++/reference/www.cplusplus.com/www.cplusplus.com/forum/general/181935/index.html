<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Crash when assigning values, but only me - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/v321/main.css">
<script src="/v321/main.js" type="text/javascript"></script>
<script type='text/javascript'>
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
(function() {
var gads = document.createElement('script');
gads.async = true;
gads.type = 'text/javascript';
var useSSL = 'https:' == document.location.protocol;
gads.src = (useSSL ? 'https:' : 'http:') + 
'//www.googletagservices.com/tag/js/gpt.js';
var node = document.getElementsByTagName('script')[0];
node.parentNode.insertBefore(gads, node);
})();
</script>

<script type='text/javascript'>
googletag.cmd.push(function() {
googletag.defineSlot('/32882001/L', [728, 90], 'div-gpt-ad-1427191279638-0').addService(googletag.pubads());
googletag.enableServices();
});
</script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="/" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="/forum/">Forum</a></li>
<li><a href="/forum/general/">General C++ Programming</a></li>
<li class="here">Crash when assigning values, but only me</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support">
<div id='div-gpt-ad-1427191279638-0' style='width:728px; height:90px;'>
<script type='text/javascript'>
googletag.cmd.push(function() { googletag.display('div-gpt-ad-1427191279638-0'); });
</script>
</div>
</div>
<div id="I_content">
<h3><div class="C_ico question" title="question">&nbsp;</div><div class="C_ico solved" title="solved">&nbsp;</div> Crash when assigning values, but only meaningful ones</h3><span id="CH_edttl"></span><span class="rootdatPost" title="181935,root,0,-1,5,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg891991"><span title="891991,70328,1023,8,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg891991" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm34c348e80a" title="Wed, 30 Dec 2015 03:52:24 +0000"></span><script type="text/javascript">WhenId('CH_zTm34c348e80a');</script><noscript>Dec 30, 2015 at 3:52am UTC</noscript></div>
<div class="dwho"><a href="/user/Some_Moron/"><b>Some Moron</b> (8)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i891991">
- I doubt anyone else will have this particular problem, but have a discussion topic.  This problem has been fixed and was related to the MASSIVELY quirky way that bitmap information is stored and accessed in the Acknex "3D Game Studio" engine.  Thanks to those who gave their suggestions. -<br>
<br>
Here's a puzzler.  Why would a variable assignment crash, but only when trying to assign a useful value?<br>
<br>
The project is a video encoder that takes a 3d rendered scene and passes it on to the ffmpeg library as the next frame of a video.  Everything is perfectly fine - until this.<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br></code></pre></td>
<td class="source"><pre><code><var>void</var> videoDrawFrame(<var>void</var>* finalbits, var wid, var hei)
{
    size_t width = _INT(wid);
    size_t height = _INT(hei);
    <var>for</var> (size_t y = 0;y&lt;height;y++)
    {
		<var>for</var> (size_t x = 0;x&lt;width;x++)
		{
		    size_t offset = (y*width+x) * 3;
           	 <var>char</var>* c = (<var>char</var>*)(finalbits);
            	m_VideoRGBFrame[offset+0] = 10; <cite>// These work fine, proving it's okay to write to all these addresses</cite>
           	 m_VideoRGBFrame[offset+1] = 10;
            	m_VideoRGBFrame[offset+2] = 10;
            	<cite>// Following is my attempt to debug the problem.</cite>
            	<var>char</var> test = c[2+offset]; <cite>// These work fine, proving it's okay to read from all these addresses of the finalbits array.</cite>
            	test = c[1+offset];
           	 test = c[0+offset];

           	m_VideoRGBFrame[offset+0] = test; <cite>// THIS crashes the program!  Commenting out this line makes it run (but not do anything useful.)</cite>

			<cite>// The following three lines are what I WANT the program to do.  But uncommenting guarantees a crash.</cite>
            
			<cite>/*m_VideoRGBFrame[offset+0] = c[2+offset];
			m_VideoRGBFrame[offset+1] = c[1+offset];
			m_VideoRGBFrame[offset+2] = c[0+offset];*/</cite>
		}
	}

	<cite>// Commenting out this line does not solve the crash, proving that what's done with the data isn't the cause.</cite>
	MovieEncoderClass-&gt;WriteFrame(m_VideoRGBFrame); 
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
"What kind of code is THAT?" you ask.  Here's some information.<br>
- var is a fixed-point number typedef'd to a long, used by the rendering engine.  The _INT macro converts it to a valid int.  Otherwise not relevant.<br>
- m_VideoRGBFrame is a char* that was previously allocated with a size of (width*height*3), meaning 3 bytes per video pixel.  The lines of test code (second comment) prove that the memory was allocated properly.<br>
- finalbits is the raw data of the input bitmap.<br>
- Yes, some offsets are backwards.  The input bitmap is presented to me in BGR byte order, while the video encoder expects RGB.<br>
- I have no idea what happened with the indenting.  Looks fine in the IDE, but a bit messy here.  At least it's got some indenting.<br>
<br>
Over the last several years I have written many, many C++ projects, and not ONCE have I ever seen this happen.  Does anyone have any thoughts?<br>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTmc772349873" title="Sun, 03 Jan 2016 18:53:31 +0000"></span><script type="text/javascript">WhenId('CH_zTmc772349873');</script><noscript>Jan 3, 2016 at 6:53pm UTC</noscript></span>
<span class="dbtn" id="CH_btn891991"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892011"><span title="892011,99183,1023,113,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892011" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm40dc482efc" title="Wed, 30 Dec 2015 05:54:46 +0000"></span><script type="text/javascript">WhenId('CH_zTm40dc482efc');</script><noscript>Dec 30, 2015 at 5:54am UTC</noscript></div>
<div class="dwho"><a href="/user/heepoo/"><b>heepoo</b> (113)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892011">
what is the error?<br>
how mutch have you allocated to array?<br>
maybe it raised a run-time error<br>
check that the index doesn't go larger the array's last index
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn892011"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892112"><span title="892112,70328,1023,8,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892112" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm8389c6975e" title="Wed, 30 Dec 2015 18:54:50 +0000"></span><script type="text/javascript">WhenId('CH_zTm8389c6975e');</script><noscript>Dec 30, 2015 at 6:54pm UTC</noscript></div>
<div class="dwho"><a href="/user/Some_Moron/"><b>Some Moron</b> (8)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892112">
The project compiles into a DLL plugin for the Acknex engine, which unfortunately has very poor debugging tools and only tells me "Crash in renderVideo" as a popup message.<br>
<br>
The test video runs at 1280x720, thereby requiring allocation of 2,764,800 bytes of memory.  Both my desktop and laptop systems exhibit the problem.  I haven't checked the laptop specs but the desktop is using less than half of its 8GB RAM.<br>
<br>
If the problem were the array index, the example would crash every time.  But line 19 does exactly the same thing that previously worked, except using a different assigned value than the hard-coded test of 10.  Changing the magic number 10 to something else doesn't change anything - even when trying 0 or a number that would overflow a char, such as 256.<br>
<br>
I do have a debug function that prints a specific variable into a MessageBox, and it has no problem accessing the "test" char variable after it has been set. It reports a value of 0, which itself seems incorrect to me but is not the particular mystery I'm trying to solve here.<br>
<br>
Edit:  Incidentally, instructing the code to pause after every iteration still makes it crash immediately, i.e. we can be reasonably certain the array is not going out of bounds as the problem even occurs at the beginning.
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm8e7a92838d" title="Wed, 30 Dec 2015 19:00:45 +0000"></span><script type="text/javascript">WhenId('CH_zTm8e7a92838d');</script><noscript>Dec 30, 2015 at 7:00pm UTC</noscript></span>
<span class="dbtn" id="CH_btn892112"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892117"><span title="892117,37152,1023,8201,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892117" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTmd923832d49" title="Wed, 30 Dec 2015 20:08:52 +0000"></span><script type="text/javascript">WhenId('CH_zTmd923832d49');</script><noscript>Dec 30, 2015 at 8:08pm UTC</noscript></div>
<div class="dwho"><a href="/user/ne555/"><b>ne555</b> (8201)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892117">
&gt; These work fine, proving it's okay to write to all these addresses<br>
&gt; If the problem were the array index, the example would crash every time.<br>
that's your error, you are assuming things.<br>
Accessing out of bounds is <i>undefined</i> behaviour.<br>
<br>
Also, the compiler may be optimizing things if you use constants.<br>
<br>
<br>
&gt; var is a fixed-point number typedef'd to a long, used by the rendering<br>
&gt; engine. The _INT macro converts it to a valid int. Otherwise not relevant.<br>
you've got a <span class="auto"><code class="source"><var>long</var></code></span> and cast it to an <span class="auto"><code class="source"><var>int</var></code></span> to assign it to a <span class="auto"><code class="source">size_t</code></span><br>
¿why bother?<br>
<br>
<br>
&gt; m_VideoRGBFrame is a char* that was previously allocated <br>
¿a global variable?<br>
<br>
<br>
&gt; I have no idea what happened with the indenting.<br>
you mixed spaces and tabs<br>
<br>
&gt; I do have a debug function that prints a specific variable<br>
¿don't you have a debugger?<br>
¿can't run your program through valgrind or similar?<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn892117"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg892133"><span title="892133,70328,1023,8,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg892133" title="Link to this post"><img src="/img/link.png" width="16" height="8"></a> <span id="CH_zTm29d81ddb73" title="Wed, 30 Dec 2015 21:26:22 +0000"></span><script type="text/javascript">WhenId('CH_zTm29d81ddb73');</script><noscript>Dec 30, 2015 at 9:26pm UTC</noscript></div>
<div class="dwho"><a href="/user/Some_Moron/"><b>Some Moron</b> (8)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i892133">
I haven't previously used valgrind, but I will look into it to see if it helps.<br>
<br>
I will also see if the (yes, global) char* can be bypassed entirely for direct buffer editing.<br>
<br>
Also, I fully agree that all the casting sounds very stupid, but this seems to be the only way to do it.  <tt>var</tt> and <tt>int</tt> don't store equivalent values (one is offset by 10 bits).  Skipping the cast would result in accessing an element <i>way</i> out of range.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn892133"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Topic archived. No new replies allowed.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(181935,1,70328,1,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','/forum/thread.cgi','/forum/post.cgi','/forum/myposts.cgi',64,32,512,256,1024,16);</script></div>
<script type="text/javascript">
    google_ad_client = "ca-pub-1444228343479937";
    google_ad_slot = "9701143201";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- leaderboard -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="/">C++</a></b></h3>
<ul>
<li class="folder info"><a href="/info/">Information</a></li>
<li class="folder doc"><a href="/doc/">Tutorials</a></li>
<li class="folder reference"><a href="/reference/">Reference</a></li>
<li class="folder articles"><a href="/articles/">Articles</a></li>
<li class="folder selected forum"><a href="/forum/">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="/forum/">Forum</a></b></h3>
<ul>
<li><a href="/forum/beginner/"><b>Beginners</b></a></li><li><a href="/forum/windows/"><b>Windows Programming</b></a></li><li><a href="/forum/unices/"><b>UNIX/Linux Programming</b></a></li><li class="selected"><a href="/forum/general/"><b>General C++ Programming</b></a></li><li><a href="/forum/lounge/"><b>Lounge</b></a></li><li><a href="/forum/jobs/"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="/">Home page</a> | <a href="/privacy.do">Privacy policy</a><br>&copy; cplusplus.com, 2000-2016 - All rights reserved - <i>v3.1</i><br><a href="/contact.do?referrer=www.cplusplus.com%2Fforum%2Fgeneral%2F181935%2F">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="/user/">'+us.user+'</a></b></h3><ul><li><a href="/forum/myposts.cgi">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>